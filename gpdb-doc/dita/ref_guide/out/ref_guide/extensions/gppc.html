<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="topic" />
<meta name="DC.title" content="Greenplum Partner Connector API" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="topic1" />
<meta name="DC.language" content="en" />
<link rel="stylesheet" type="text/css" href="../commonltr.css" />
<title>Greenplum Partner Connector API</title>
</head>
<body id="topic1">

  <h1 class="title topictitle1" id="topic1__py212122">Greenplum Partner Connector API</h1>

  <div class="body">
      <p class="p">With the Greenplum Partner Connector API (GPPC API), you can write
        portable Greenplum Database user-defined functions (UDFs) in the C and
        C++ programming languages. Functions that you develop with the GPPC API
        require no recompilation or modification to work with older or newer
        Greenplum Database versions.</p>

      <p class="p">Functions that you write to the GPPC API can be invoked using SQL
        in Greenplum Database. The API provides a set of functions and macros
        that you can use to issue SQL commands through the Server Programming
        Interface (SPI), manipulate simple and composite data type function
        arguments and return values, manage memory, and handle data.</p>

      <p class="p">You compile the C/C++ functions that you develop with the GPPC API
        into a shared library. The GPPC functions are available to Greenplum
        Database users after the shared library is installed in the Greenplum
        Database cluster and the GPPC functions are registered as SQL UDFs.</p>

      <div class="note"><span class="notetitle">Note:</span> The Greenplum Partner Connector is supported for Greenplum Database
        versions 4.3.5.0 and later.</div>

    <p class="p">This topic contains the following information:</p>

    <ul class="ul">
      <li class="li" id="topic1__py219392">
        <a class="xref" href="#topic_dev">Using the GPPC API</a><ul class="ul">
          <li class="li"><a class="xref" href="#topic_reqs">Requirements</a></li>

          <li class="li"><a class="xref" href="#topic_files">Header and Library Files</a></li>

          <li class="li"><a class="xref" href="#topic_data">Data Types</a></li>

          <li class="li"><a class="xref" href="#topic_argres">Function Declaration, Arguments, and Results</a></li>

          <li class="li"><a class="xref" href="#topic_mem">Memory Handling</a></li>

          <li class="li"><a class="xref" href="#topic_varlentext">Working With Variable-Length Text Types</a></li>

          <li class="li"><a class="xref" href="#topic_errrpt">Error Reporting and Logging</a></li>

          <li class="li"><a class="xref" href="#topic_spi">SPI Functions</a></li>

          <li class="li"><a class="xref" href="#topic_tuple">About Tuple Descriptors and Tuples</a></li>

          <li class="li"><a class="xref" href="#topic_srf">Set-Returning Functions</a></li>

          <li class="li"><a class="xref" href="#topic_tblfunc">Table Functions</a></li>

          <li class="li"><a class="xref" href="#topic_limits">Limitations</a></li>

          <li class="li"><a class="xref" href="#topic_samplecode">Sample Code</a></li>

        </ul>

      </li>

      <li class="li" id="topic1__py219393">
        <a class="xref" href="#topic_build">Building a GPPC Shared Library with PGXS</a>
      </li>

      <li class="li" id="topic1__py219391">
        <a class="xref" href="#topic_reg">Registering a GPPC Function with Greenplum Database</a>
      </li>

      <li class="li" id="topic1__py219394">
        <a class="xref" href="#topic_deploy">Packaging and Deployment Considerations</a>
      </li>

      <li class="li" id="topic1__py219396">
        <a class="xref" href="#topic_example_text">GPPC Text Function Example</a>
      </li>

      <li class="li" id="topic1__py219397">
        <a class="xref" href="#topic_example_srf">GPPC Set-Returning Function Example</a>
      </li>

    </ul>

  </div>


  <div class="topic nested1" aria-labelledby="topic_dev__py21716799" xml:lang="en" lang="en" id="topic_dev">
    <h2 class="title topictitle2" id="topic_dev__py21716799">Using the GPPC API</h2>

    <div class="body">
      <p class="p">The GPPC API shares some concepts with C language functions as defined
        by PostgreSQL. Refer to <a class="xref" href="https://www.postgresql.org/docs/9.4/xfunc-c.html" target="_blank">C-Language Functions</a>
        in the PostgreSQL documentation for detailed information about developing
        C language functions.</p>

      <p class="p">The GPPC API is a wrapper that makes a C/C++ function SQL-invokable
        in Greenplum Database. This wrapper shields GPPC functions that you
         write from Greenplum Database library changes by normalizing table
         and data manipulation and SPI operations through functions and macros
         defined by the API.</p>

      <p class="p">The GPPC API includes functions and macros to:</p>
<ul class="ul">
        <li class="li">Operate on base and composite data types.</li>

        <li class="li">Process function arguments and return values.</li>

        <li class="li">Allocate and free memory.</li>

        <li class="li">Log and report errors to the client.</li>

        <li class="li">Issue SPI queries.</li>

        <li class="li">Return a table or set of rows.</li>

        <li class="li">Process tables as function input arguments.</li>

      </ul>

    </div>

    <div class="topic nested2" aria-labelledby="topic_reqs__py217167" xml:lang="en" lang="en" id="topic_reqs">
      <h3 class="title topictitle3" id="topic_reqs__py217167">Requirements</h3>

      <div class="body">
        <p class="p">When you develop with the GPPC API:</p>
<ul class="ul">
          <li class="li">You must develop your code on a system with the same hardware and
            software architecture as that of your Greenplum Database hosts.</li>

          <li class="li">You must write the GPPC function(s) in the C or C++ programming 
            languages.</li>

          <li class="li">The function code must use the GPPC API, data types, and macros.</li>

          <li class="li">The function code must <em class="ph i">not</em> use the PostgreSQL C-Language
            Function API, header files, functions, or macros.</li>

          <li class="li">The function code must <em class="ph i">not</em> <code class="ph codeph">#include</code> the
            <code class="ph codeph">postgres.h</code> header file or use <code class="ph codeph">PG_MODULE_MAGIC</code>.</li>

          <li class="li">You must use only the GPPC-wrapped memory functions to allocate
            and free memory. See <a class="xref" href="#topic_mem">Memory Handling</a>.</li>

          <li class="li">Symbol names in your object files must not conflict with each
            other nor with symbols defined in the Greenplum Database server.
            You must rename your functions or variables if you get error messages
            to this effect.</li>

        </ul>

      </div>

    </div>

    <div class="topic nested2" aria-labelledby="topic_files__py217167" xml:lang="en" lang="en" id="topic_files">
      <h3 class="title topictitle3" id="topic_files__py217167">Header and Library Files</h3>

      <div class="body">
        <p class="p">The GPPC header files and libraries are installed in 
          <code class="ph codeph">$GPHOME</code>:</p>
<ul class="ul">
          <li class="li">$GPHOME/include/gppc.h - the main GPPC header file</li>

          <li class="li">$GPHOME/include/gppc_config.h - header file defining the GPPC
            version</li>

          <li class="li">$GPHOME/lib/libgppc.[a, so, so.1, so.1.2] - GPPC archive and
            shared libraries</li>

        </ul>

      </div>

    </div>

    <div class="topic nested2" aria-labelledby="topic_data__py217167" xml:lang="en" lang="en" id="topic_data">
      <h3 class="title topictitle3" id="topic_data__py217167">Data Types</h3>

      <div class="body">
        <p class="p">The GPPC functions that you create will operate on data residing
          in Greenplum Database. The GPPC API includes data type definitions for equivalent
          Greenplum Database SQL data types. You must use these types in your
          GPPC functions.</p>

        <div class="p">The GPPC API defines a generic data type that you can use to
          represent any GPPC type.
          This data type is named <code class="ph codeph">GppcDatum</code>, and is defined
          as follows:
          <pre class="pre codeblock"><code>typedef int64_t GppcDatum;</code></pre></div>

        <p class="p">The following table identifies each GPPC data type and the SQL
          type to which it maps.</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_data__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:30.923694779116467%" /><col style="width:34.53815261044177%" /><col style="width:34.53815261044177%" /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e309">SQL Type</th>

              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e312">GPPC Type</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e315">GPPC Oid for Type</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">boolean</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcBool</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidBool</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">char (single byte)</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcChar</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidChar</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">int2/smallint</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcInt2</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidInt2</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">int4/integer</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcInt4</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidInt4</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">int8/bigint</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcInt8</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidInt8</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">float4/real</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcFloat4</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidFloat4</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">float8/double</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcFloat8</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidFloat8</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">text</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcText</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidText</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">varchar</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcVarChar</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidVarChar</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">char</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcBpChar</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidBpChar</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">bytea</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcBytea</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidBytea</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">numeric</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcNumeric</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidNumeric</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">date</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcDate</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidDate</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">time</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcTime</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidTime</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">timetz</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">*GppcTimeTz</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidTimeTz</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">timestamp</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcTimestamp</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidTimestamp</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">timestamptz</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcTimestampTz</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidTimestampTz</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e309 ">anytable</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e312 ">GppcAnyTable</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e315 ">GppcOidAnyTable</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e309 ">oid</td>

              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e312 ">GppcOid</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e315 ">Â </td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p"> </p>

        <p class="p">The GPPC API treats text, numeric, and timestamp data types specially,
           providing functions to operate on these types.</p>

        <div class="p">Example GPPC base data type declarations:<pre class="pre codeblock"><code>GppcText       message;
GppcInt4       arg1;
GppcNumeric    total_sales;</code></pre></div>

        <div class="p">The GPPC API defines functions to convert between the generic
          <code class="ph codeph">GppcDatum</code> type and the GPPC specific types. For
          example, to convert from an integer to a datum:<pre class="pre codeblock"><code>
GppcInt4 num = 13;
GppcDatum num_dat = GppcInt4GetDatum(num);</code></pre></div>

      </div>

      <div class="topic nested3" aria-labelledby="topic_composite__py217167" xml:lang="en" lang="en" id="topic_composite">
        <h4 class="title topictitle4" id="topic_composite__py217167">Composite Types</h4>

        <div class="body">
          <p class="p">A composite data type represents the structure of a row or record,
            and is comprised of a list of field names and their data types.
            This structure information is typically referred to as a tuple
            descriptor. An instance of a composite type is typically referred
            to as a tuple or row. A tuple does not have a fixed layout and can
            contain null fields.</p>

          <p class="p">The GPPC API provides an interface that you can use to define
            the structure of, to access, and to set tuples. You will use this
            interface when your GPPC function takes a table as an input
            argument or returns table or set of record types. Using tuples
            in table and set returning functions is covered later in this
            topic.</p>

        </div>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_argres__py217167" xml:lang="en" lang="en" id="topic_argres">
      <h3 class="title topictitle3" id="topic_argres__py217167">Function Declaration, Arguments, and Results</h3>

      <div class="body">
        <p class="p">The GPPC API relies on macros to declare functions and to simplify
          the passing of function arguments and results. These macros include:</p>


        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_argres__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:25.0814332247557%" /><col style="width:28.013029315960914%" /><col style="width:46.90553745928339%" /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e618">Task</th>

              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e621">Macro Signature</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e624">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Make a function SQL-invokable</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_FUNCTION_INFO(<var class="keyword varname">function_name</var>)</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Glue to make function <code class="ph codeph"><var class="keyword varname">function_name</var></code> SQL-invokable.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Declare a function</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GppcDatum <var class="keyword varname">function_name</var>(GPPC_FUNCTION_ARGS)</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Declare a GPPC function named <code class="ph codeph"><var class="keyword varname">function_name</var></code>; every function must have this same signature.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Return the number of arguments</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_NARGS()</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Return the number of arguments passed to the function.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Fetch an argument</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_GETARG_&lt;ARGTYPE&gt;(<var class="keyword varname">arg_num</var>)</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Fetch the value of argument number <var class="keyword varname">arg_num</var> (starts at 0), where <code class="ph codeph">&lt;ARGTYPE&gt;</code> identifies the data type of the argument. For example, <code class="ph codeph">GPPC_GETARG_FLOAT8(0)</code>.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Fetch and make a copy of a text-type argument</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_GETARG_&lt;ARGTYPE&gt;_COPY(<var class="keyword varname">arg_num</var>)</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Fetch and make a copy of the value of argument number <var class="keyword varname">arg_num</var> (starts at 0). <code class="ph codeph">&lt;ARGTYPE&gt;</code> identifies the text type (text, varchar, bpchar, bytea). For example, <code class="ph codeph">GPPC_GETARG_BYTEA_COPY(1)</code>.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e618 ">Determine if an argument is NULL</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_ARGISNULL(<var class="keyword varname">arg_num</var>)</code></td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e624 ">Return whether or not argument number <code class="ph codeph"><var class="keyword varname">arg_num</var></code> is NULL.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e618 ">Return a result</td>

              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e621 "><code class="ph codeph">GPPC_RETURN_&lt;ARGTYPE&gt;(<var class="keyword varname">return_val</var>)</code></td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e624 ">Return the value <code class="ph codeph"><var class="keyword varname">return_val</var></code>, where <code class="ph codeph">&lt;ARGTYPE&gt;</code> identifies the data type of the return value. For example, <code class="ph codeph">GPPC_RETURN_INT4(131)</code>.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p">  </p>

         <div class="p">When you define and implement your GPPC function, you must declare it
           with the GPPC API using the two declarations identified
           above. For example, to declare a GPPC function named
           <code class="ph codeph">add_int4s()</code>:<pre class="pre codeblock"><code>GPPC_FUNCTION_INFO(add_int4s);
GppcDatum add_int4s(GPPC_FUNCTION_ARGS);

GppcDatum
add_int4s(GPPC_FUNCTION_ARGS)
{
  // code here
}</code></pre></div>

        <div class="p">If the <code class="ph codeph">add_int4s()</code> function takes two input
          arguments of type <code class="ph codeph">int4</code>, you use the
          <code class="ph codeph">GPPC_GETARG_INT4(<var class="keyword varname">arg_num</var>)</code> macro
          to access the argument values. The argument index starts at 0.
          For example:<pre class="pre codeblock"><code>GppcInt4  first_int = GPPC_GETARG_INT4(0);
GppcInt4  second_int = GPPC_GETARG_INT4(1);</code></pre>  </div>

        <div class="p">If <code class="ph codeph">add_int4s()</code> returns the sum of the two input
          arguments, you use the <code class="ph codeph">GPPC_RETURN_INT8(<var class="keyword varname">return_val</var>)</code>
          macro to return this sum. For example:<pre class="pre codeblock"><code>GppcInt8  sum = first_int + second_int;
GPPC_RETURN_INT8(sum);</code></pre>  </div>

         <div class="p">The complete GPPC function:<pre class="pre codeblock"><code>GPPC_FUNCTION_INFO(add_int4s);
GppcDatum add_int4s(GPPC_FUNCTION_ARGS);

GppcDatum
add_int4s(GPPC_FUNCTION_ARGS)
{
  // get input arguments
  GppcInt4    first_int = GPPC_GETARG_INT4(0);
  GppcInt4    second_int = GPPC_GETARG_INT4(1);

  // add the arguments
  GppcInt8    sum = first_int + second_int;

  // return the sum
  GPPC_RETURN_INT8(sum);
}</code></pre></div>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_mem__py217167" xml:lang="en" lang="en" id="topic_mem">
      <h3 class="title topictitle3" id="topic_mem__py217167">Memory Handling</h3>

      <div class="body">
        <p class="p">The GPPC API provides functions that you use to allocate and free
          memory, including text memory. You must use these functions for all
          memory operations.</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_mem__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:52.760736196319016%" /><col style="width:47.239263803680984%" /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e860">Function Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e863">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e860 ">void *GppcAlloc( size_t <var class="keyword varname">num</var> )</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e863 ">Allocate <var class="keyword varname">num</var> bytes of uninitialized memory.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e860 ">void *GppcAlloc0( size_t <var class="keyword varname">num</var> )</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e863 ">Allocate <var class="keyword varname">num</var> bytes of 0-initialized memory.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e860 ">void *GppcRealloc( void *<var class="keyword varname">ptr</var>, size_t <var class="keyword varname">num</var> )</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e863 ">Resize pre-allocated memory.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e860 ">void GppcFree( void *<var class="keyword varname">ptr</var> )</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e863 ">Free allocated memory.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p">After you allocate memory, you can use system functions such as
          <code class="ph codeph">memcpy()</code> to set the data.</p>

        <div class="p">The following example allocates an array of
          <code class="ph codeph">GppcDatum</code>s and sets the array to datum versions
          of the function input arguments:<pre class="pre codeblock"><code>GppcDatum  *values;
int attnum = GPPC_NARGS();

// allocate memory for attnum values
values = GppcAlloc( sizeof(GppcDatum) * attnum );

// set the values
for( int i=0; i&lt;attnum; i++ ) {
    GppcDatum d = GPPC_GETARG_DATUM(i);
    values[i] = d;
}</code></pre></div>


        <p class="p">When you allocate memory for a GPPC function, you allocate it in
          the current context. The GPPC API includes functions to return, 
          create, switch, and reset memory contexts.</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_mem__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:61.34969325153374%" /><col style="width:38.65030674846626%" /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e962">Function Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e965">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e962 ">GppcMemoryContext GppcGetCurrentMemoryContext(void)</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e965 ">Return the current memory context.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e962 ">GppcMemoryContext GppcMemoryContextCreate(GppcMemoryContext <var class="keyword varname">parent</var>)</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e965 ">Create a new memory context under <var class="keyword varname">parent</var>.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e962 ">GppcMemoryContext GppcMemoryContextSwitchTo(GppcMemoryContext <var class="keyword varname">context</var>)</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e965 ">Switch to the memory context <var class="keyword varname">context</var>.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e962 ">void GppcMemoryContextReset(GppcMemoryContext <var class="keyword varname">context</var>)</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e965 ">Reset (free) the memory in  memory context <var class="keyword varname">context</var>.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p">Greenplum Database typically calls a SQL-invoked function in a
          per-tuple context that it creates and deletes every time the server
          backend processes a table row. Do not assume that memory allocated
          in the current memory context is available across multiple function
          calls.</p>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_varlentext__py217167" xml:lang="en" lang="en" id="topic_varlentext">
      <h3 class="title topictitle3" id="topic_varlentext__py217167">Working With Variable-Length Text Types</h3>

      <div class="body">
        <p class="p">The GPPC API supports the variable length text, varchar, blank
          padded, and byte array types. You must use the GPPC API-provided
          functions when you operate on these data types. Variable text
          manipulation functions provided in the GPPC API include those to
          allocate memory for, determine string length of, get string pointers
          for, and access these types:</p>

          
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_varlentext__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:58.333333333333336%" /><col style="width:41.66666666666667%" /></colgroup><thead class="thead" style="text-align:left;">
              <tr class="row">
                <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1056">Function Name</th>

                <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1059">Description</th>

              </tr>

            </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1056 ">GppcText GppcAllocText( size_t <var class="keyword varname">len</var> )<p class="p">GppcVarChar GppcAllocVarChar( size_t <var class="keyword varname">len</var> )</p>
<p class="p">GppcBpChar GppcAllocBpChar( size_t <var class="keyword varname">len</var> )</p>
<p class="p">GppcBytea GppcAllocBytea( size_t <var class="keyword varname">len</var> )</p>
</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1059 ">Allocate <var class="keyword varname">len</var> bytes of memory for the varying length type.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1056 ">size_t GppcGetTextLength( GppcText <var class="keyword varname">s</var> )<p class="p">size_t GppcGetVarCharLength( GppcVarChar <var class="keyword varname">s</var> )</p>
<p class="p">size_t GppcGetBpCharLength( GppcBpChar <var class="keyword varname">s</var> )</p>
<p class="p">size_t GppcGetByteaLength( GppcBytea <var class="keyword varname">b</var> )</p>
</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1059 ">Return the number of bytes in the memory chunk.</td>

            </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1056 ">char *GppcGetTextPointer( GppcText <var class="keyword varname">s</var> )<p class="p">char *GppcGetVarCharPointer( GppcVarChar <var class="keyword varname">s</var> )</p>
<p class="p">char *GppcGetBpCharPointer( GppcBpChar <var class="keyword varname">s</var> )</p>
<p class="p">char *GppcGetByteaPointer( GppcBytea <var class="keyword varname">b</var> )</p>
</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1059 ">Return a string pointer to the head of the memory chunk. The string is not null-terminated.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1056 ">char *GppcTextGetCString( GppcText <var class="keyword varname">s</var> )<p class="p">char *GppcVarCharGetCString( GppcVarChar <var class="keyword varname">s</var> )</p>
<p class="p">char *GppcBpCharGetCString( GppcBpChar <var class="keyword varname">s</var> )</p>
</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1059 ">Return a string pointer to the head of the memory chunk. The string is null-terminated.</td>

              </tr>

              <tr class="row">
                <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1056 ">GppcText *GppcCStringGetText( const char *<var class="keyword varname">s</var> )<p class="p">GppcVarChar *GppcCStringGetVarChar( const char *<var class="keyword varname">s</var> )</p>
<p class="p">GppcBpChar *GppcCStringGetBpChar( const char *<var class="keyword varname">s</var> )</p>
</td>

                <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1059 ">Build a varying-length type from a character string.</td>

              </tr>

            </tbody>
</table>
</div>

          <p class="p">Memory returned by the <code class="ph codeph">GppcGet&lt;VLEN_ARGTYPE&gt;Pointer()</code>
            functions may point to actual database content. Do not modify the
            memory content. The GPPC API provides functions to allocate memory
            for these types should you require it. After you allocate memory,
            you can use system functions such as <code class="ph codeph">memcpy()</code>
            to set the data.</p>

          <div class="p">The following example manipulates text input arguments and
            allocates and sets result memory for a text string concatenation
            operation:<pre class="pre codeblock"><code>GppcText first_textstr = GPPC_GETARG_TEXT(0);
GppcText second_textstr = GPPC_GETARG_TEXT(1);

// determine the size of the concatenated string and allocate
// text memory of this size
size_t arg0_len = GppcGetTextLength(first_textstr);
size_t arg1_len = GppcGetTextLength(second_textstr);
GppcText retstring = GppcAllocText(arg0_len + arg1_len);

// construct the concatenated return string; copying each string
// individually
memcpy(GppcGetTextPointer(retstring), GppcGetTextPointer(first_textstr), arg0_len);
memcpy(GppcGetTextPointer(retstring) + arg0_len, GppcGetTextPointer(second_textstr), arg1_len);
</code></pre></div>

        </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_errrpt__py217167" xml:lang="en" lang="en" id="topic_errrpt">
      <h3 class="title topictitle3" id="topic_errrpt__py217167">Error Reporting and Logging</h3>

      <div class="body">
        <div class="p">The GPPC API provides error reporting and logging functions. The
          API defines reporting levels equivalent to those in Greenplum
          Database:<pre class="pre codeblock"><code>typedef enum GppcReportLevel
{
        GPPC_DEBUG1                             = 10,
        GPPC_DEBUG2                             = 11,
        GPPC_DEBUG3                             = 12,
        GPPC_DEBUG4                             = 13,
        GPPC_DEBUG                              = 14,
        GPPC_LOG                                = 15,
        GPPC_INFO                               = 17,
        GPPC_NOTICE                             = 18,
        GPPC_WARNING                    	= 19,
        GPPC_ERROR                              = 20,
} GppcReportLevel;
</code></pre>(The Greenplum Database <a class="xref" href="../config_params/guc-list.html#client_min_messages"><code class="ph codeph">client_min_messages</code></a>
          server configuration parameter governs the current client logging
          level. The <a class="xref" href="../config_params/guc-list.html#client_min_messages"><code class="ph codeph">log_min_messages</code></a>
          configuration parameter governs the current log-to-logfile level.)</div>

        <p class="p">A GPPC report includes the report level, a report message, and an
          optional report callback function.</p>

        <p class="p">Reporting and handling functions provide by the GPPC API include:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_errrpt__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:49.079754601226995%" /><col style="width:50.920245398773%" /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1256">Function Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1259">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1256 ">GppcReport()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1259 ">Format and print/log a string of the specified report level.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1256 ">GppcInstallReportCallback()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1259 ">Register/install a report callback function.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1256 ">GppcUninstallReportCallback()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1259 ">Uninstall a report callback function.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1256 ">GppcGetReportLevel()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1259 ">Retrieve the level from an error report.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1256 ">GppcGetReportMessage()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1259 ">Retrieve the message from an error report.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1256 ">GppcCheckForInterrupts()</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1259 ">Error out if an interrupt is pending.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p"> </p>

        <div class="p">The <code class="ph codeph">GppcReport()</code> function signature
          is:<pre class="pre codeblock"><code>void GppcReport(GppcReportLevel elevel, const char *fmt, ...);</code></pre></div>

        <div class="p"><code class="ph codeph">GppcReport()</code> takes a format string input argument
          similar to <code class="ph codeph">printf()</code>. The following example generates
          an error level report message that formats a GPPC text argument:
          <pre class="pre codeblock"><code>GppcText  uname = GPPC_GETARG_TEXT(1);
GppcReport(GPPC_ERROR, "Unknown user name: %s", GppcTextGetCString(uname));</code></pre></div>

        <p class="p">Refer to the <a class="xref" href="https://github.com/greenplum-db/gpdb/tree/master/src/interfaces/gppc/test" target="_blank">GPPC example code</a>
          for example report callback handlers.</p>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_spi__py217167" xml:lang="en" lang="en" id="topic_spi">
      <h3 class="title topictitle3" id="topic_spi__py217167">SPI Functions</h3>

      <div class="body">
        <p class="p">The Greenplum Database Server Programming Interface (SPI) provides
          writers of C/C++ functions the ability to run SQL commands within a
          GPPC function. For additional information on SPI functions, refer to
           <a class="xref" href="https://www.postgresql.org/docs/9.4/spi.html" target="_blank">Server Programming Interface</a>
            in the PostgreSQL documentation.</p>

       <p class="p">The GPPC API exposes a subset of PostgreSQL SPI functions. This
         subset enables you to issue SPI queries and retrieve SPI result
         values in your GPPC function. The GPPC SPI wrapper functions are:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_spi__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:34.18803418803419%" /><col style="width:57" /><col style="width:65.8119658119658%" /><col /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1387">SPI Function Name</th>

              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1390">GPPC Function Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1393">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1387 ">SPI_connect()</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIConnect()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Connect to the Greenplum Database server programming interface.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1387 ">SPI_finish()</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIFinish()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Disconnect from the Greenplum Database server programming interface.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1387 ">SPI_exec()</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIExec()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Run a SQL statement, returning the number of rows.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" rowspan="4" style="vertical-align:top;" headers="d43874e1387 ">SPI_getvalue()</td>

              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIGetValue()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Retrieve the value of a specific attribute by number from a SQL result as a character string.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIGetDatum()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Retrieve the value of a specific attribute by number from a SQL result as a <code class="ph codeph">GppcDatum</code>.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIGetValueByName()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1393 ">Retrieve the value of a specific attribute by name from a SQL result as a character string.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1390 ">GppcSPIGetDatumByName()</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1393 ">Retrieve the value of a specific attribute by name from a SQL result as a <code class="ph codeph">GppcDatum</code>.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p">  </p>

        <div class="p">When you create a GPPC function that accesses the server
          programming interface, your function should comply with the following
          flow:<pre class="pre codeblock"><code>GppcSPIConnect();
GppcSPIExec(...)
// process the results - GppcSPIGetValue(...), GppcSPIGetDatum(...)
GppcSPIFinish()</code></pre></div>

        <div class="p">You use <code class="ph codeph">GppcSPIExec()</code> to run SQL statements in your GPPC function. When
          you call this function, you also identify the maximum number of rows to return. The
          function signature of <code class="ph codeph">GppcSPIExec()</code>
          is:<pre class="pre codeblock"><code>GppcSPIResult GppcSPIExec(const char *sql_statement, long rcount);</code></pre></div>

        <div class="p"><code class="ph codeph">GppcSPIExec()</code> returns a <code class="ph codeph">GppcSPIResult</code>
          structure. This structure represents SPI result data. It includes a
          pointer to the data, information about the number of rows processed,
          a counter, and a result code. The GPPC API defines this structure as
          follows:<pre class="pre codeblock"><code>typedef struct GppcSPIResultData
{
    struct GppcSPITupleTableData   *tuptable;
    uint32_t                       processed;
    uint32_t                       current;
    int                            rescode;
} GppcSPIResultData;
typedef GppcSPIResultData *GppcSPIResult;</code></pre></div>

        <p class="p">You can set and use the <code class="ph codeph">current</code> field in the
          <code class="ph codeph">GppcSPIResult</code> structure to examine each row of
          the <code class="ph codeph">tuptable</code> result data.</p>

        <div class="p">The following code excerpt uses the GPPC API to connect to SPI, run a simple query, loop
          through query results, and finish
          processing:<pre class="pre codeblock"><code>GppcSPIResult   result;
char            *attname = "id";
char            *query = "SELECT i, 'foo' || i AS val FROM generate_series(1, 10)i ORDER BY 1";
bool            isnull = true;

// connect to SPI
if( GppcSPIConnect() &lt; 0 ) {
    GppcReport(GPPC_ERROR, "cannot connect to SPI");
}

// execute the query, returning all rows
result = GppcSPIExec(query, 0);

// process result
while( result-&gt;current &lt; result-&gt;processed ) {
    // get the value of attname column as a datum, making a copy
    datum = GppcSPIGetDatumByName(result, attname, &amp;isnull, true);

    // do something with value

    // move on to next row
    result-&gt;current++;
}

// complete processing
GppcSPIFinish();
</code></pre></div>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_tuple__py21716799" xml:lang="en" lang="en" id="topic_tuple">
      <h3 class="title topictitle3" id="topic_tuple__py21716799">About Tuple Descriptors and Tuples</h3>

      <div class="body">
        <div class="p">A table or a set of records contains one or more tuples (rows).
          The structure of each attribute of a tuple is defined by a tuple
          descriptor. A tuple descriptor defines the following for each
          attribute in the tuple:<ul class="ul">
           <li class="li">attribute name</li>

           <li class="li">object identifier of the attribute data type</li>

           <li class="li">byte length of the attribute data type</li>

           <li class="li">object identifier of the attribute modifer</li>

        </ul>
</div>

        <p class="p">The GPPC API defines an abstract type, <code class="ph codeph">GppcTupleDesc</code>,
          to represent a tuple/row descriptor. The API also provides functions
          that you can use to create, access, and set tuple descriptors:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_tuple__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:38.23529411764706%" /><col style="width:61.76470588235294%" /></colgroup><thead class="thead" style="text-align:left;">
              <tr class="row">
                <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1576">Function Name</th>

                <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1579">Description</th>

              </tr>

            </thead>
<tbody class="tbody">
              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcCreateTemplateTupleDesc()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Create an empty tuple descriptor with a specified number of attributes.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescInitEntry()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Add an attribute to the tuple descriptor at a specified position.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescNattrs()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Fetch the number of attributes in the tuple descriptor.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescAttrName()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Fetch the name of the attribute in a specific position (starts at 0) in the tuple descriptor.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescAttrType()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Fetch the type object identifier of the attribute in a specific position (starts at 0) in the tuple descriptor.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescAttrLen()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1579 ">Fetch the type length of an attribute in a specific position (starts at 0) in the tuple descriptor.</td>

              </tr>

              <tr class="row">
                <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1576 ">GppcTupleDescAttrTypmod()</td>

                <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1579 ">Fetch the type modifier object identifier of an attribute in a specific position (starts at 0) in the tuple descriptor.</td>

              </tr>

            </tbody>
</table>
</div>

             <p class="p">  </p>

             <div class="p">To construct a tuple descriptor, you first create a template,
               and then fill in the descriptor fields for each attribute.
               The signatures for these functions are:<pre class="pre codeblock"><code>GppcTupleDesc GppcCreateTemplateTupleDesc(int natts);
void GppcTupleDescInitEntry(GppcTupleDesc desc, uint16_t attno,
                            const char *attname, GppcOid typid, int32_t typmod);</code></pre></div>

             <div class="p">In some cases, you may want to initialize a tuple descriptor
               entry from an attribute definition in an existing tuple. The
               following functions fetch the number of attributes in a tuple
               descriptor, as well as the definition of a specific attribute
               (by number) in the descriptor:<pre class="pre codeblock"><code>int GppcTupleDescNattrs(GppcTupleDesc tupdesc);
const char *GppcTupleDescAttrName(GppcTupleDesc tupdesc, int16_t attno);
GppcOid GppcTupleDescAttrType(GppcTupleDesc tupdesc, int16_t attno);
int16_t GppcTupleDescAttrLen(GppcTupleDesc tupdesc, int16_t attno);
int32_t GppcTupleDescAttrTypmod(GppcTupleDesc tupdesc, int16_t attno);</code></pre></div>

             <div class="p">The following example initializes a two attribute tuple
               descriptor. The first attribute is initialized with the
               definition of an attribute from a different descriptor, and
               the second attribute is initialized to a boolean type attribute:
               <pre class="pre codeblock"><code>GppcTupleDesc       tdesc;
GppcTupleDesc       indesc = some_input_descriptor;

// initialize the tuple descriptor with 2 attributes
tdesc = GppcCreateTemplateTupleDesc(2);

// use third attribute from the input descriptor
GppcTupleDescInitEntry(tdesc, 1, 
	       GppcTupleDescAttrName(indesc, 2),
	       GppcTupleDescAttrType(indesc, 2),
	       GppcTupleDescAttrTypmod(indesc, 2));

// create the boolean attribute
GppcTupleDescInitEntry(tdesc, 2, "is_active", GppcOidBool, 0);
</code></pre></div>

        <p class="p">The GPPC API defines an abstract type, <code class="ph codeph">GppcHeapTuple</code>,
          to represent a tuple/record/row. A tuple is defined by its tuple
          descriptor, the value for each tuple attribute, and an indicator
          of whether or not each value is NULL.</p>

        <p class="p">The GPPC API provides functions that you can use to set and access
          a tuple and its attributes:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_tuple__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:38.23529411764706%" /><col style="width:61.76470588235294%" /></colgroup><thead class="thead" style="text-align:left;">
              <tr class="row">
                <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1693">Function Name</th>

                <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1696">Description</th>

              </tr>

            </thead>
<tbody class="tbody">
              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1693 ">GppcHeapFormTuple()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1696 ">Form a tuple from an array of <code class="ph codeph">GppcDatum</code>s.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1693 ">GppcBuildHeapTupleDatum()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1696 ">Form a <code class="ph codeph">GppcDatum</code> tuple from an array of <code class="ph codeph">GppcDatum</code>s.</td>

              </tr>

              <tr class="row">
                <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1693 ">GppcGetAttributeByName()</td>

                <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1696 ">Fetch an attribute from the tuple by name.</td>

              </tr>

              <tr class="row">
                <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1693 ">GppcGetAttributeByNum()</td>

                <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1696 ">Fetch an attribute from the tuple by number (starts at 1).</td>

              </tr>

            </tbody>
</table>
</div>

             <p class="p">  </p>

             <div class="p">The signatures for the tuple-building GPPC functions are:<pre class="pre codeblock"><code>GppcHeapTuple GppcHeapFormTuple(GppcTupleDesc tupdesc, GppcDatum *values, bool *nulls);
GppcDatum    GppcBuildHeapTupleDatum(GppcTupleDesc tupdesc, GppcDatum *values, bool *nulls);</code></pre></div>

             <div class="p">The following code excerpt constructs a <code class="ph codeph">GppcDatum</code>
               tuple from the tuple descriptor in the above code example, and
                from integer and boolean input arguments to a function:<pre class="pre codeblock"><code>GppcDatum intarg = GPPC_GETARG_INT4(0);
GppcDatum boolarg = GPPC_GETARG_BOOL(1);
GppcDatum result, values[2];
bool nulls[2] = { false, false };

// construct the values array
values[0] = intarg;
values[1] = boolarg;
result = GppcBuildHeapTupleDatum( tdesc, values, nulls );
</code></pre></div>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_srf__py217167" xml:lang="en" lang="en" id="topic_srf">
        <h3 class="title topictitle3" id="topic_srf__py217167">Set-Returning Functions</h3>

        <div class="body">
          <p class="p">Greenplum Database UDFs whose signatures include
            <code class="ph codeph">RETURNS SETOF RECORD</code> or
            <code class="ph codeph">RETURNS TABLE( ... )</code> are set-returning functions.</p>

          <p class="p">The GPPC API provides support for returning sets (for example, multiple
            rows/tuples) from a GPPC function. Greenplum Database calls a
            set-returning function (SRF) once for each row or item. The
            function must save enough state to remember what it was doing
            and to return the next row on each call. Memory that you allocate
            in the SRF context must survive across multiple function calls.</p>

          <p class="p">The GPPC API provides macros and functions to help keep track
            of and set this context, and to allocate SRF memory. They include:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_srf__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:40%" /><col style="width:60%" /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1805">Function/Macro Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1808">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_RESULT_DESC()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Get the output row tuple descriptor for this SRF. The result tuple descriptor is determined by an output table definition or a <code class="ph codeph">DESCRIBE</code> function.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_IS_FIRSTCALL()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Determine if this is the first call to the SRF.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_FIRSTCALL_INIT()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Initialize the SRF context.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_PERCALL_SETUP()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Restore the context on each call to the SRF.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_RETURN_NEXT()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Return a value from the SRF and continue processing.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GPPC_SRF_RETURN_DONE()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Signal that SRF processing is complete.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GppSRFAlloc()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Allocate memory in this SRF context.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GppSRFAlloc0()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Allocate memory in this SRF context and initialize it to zero.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1805 ">GppSRFSave()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1808 ">Save user state in this SRF context.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1805 ">GppSRFRestore()</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1808 ">Restore user state in this SRF context.</td>

            </tr>

          </tbody>
</table>
</div>

        <p class="p">  </p>

        <div class="p">The <code class="ph codeph">GppcFuncCallContext</code> structure provides the
          context for an SRF. You create this context on the first call to
          your SRF. Your set-returning GPPC function must retrieve the
          function context on each invocation. For example:<pre class="pre codeblock"><code>// set function context
GppcFuncCallContext fctx;
if (GPPC_SRF_IS_FIRSTCALL()) {
    fctx = GPPC_SRF_FIRSTCALL_INIT();
}
fctx = GPPC_SRF_PERCALL_SETUP();
// process the tuple
</code></pre></div>

         <div class="p">The GPPC function must provide the context when it returns a
           tuple result or to indicate that processing is complete. For 
           example:<pre class="pre codeblock"><code>GPPC_SRF_RETURN_NEXT(fctx, result_tuple);
// or
GPPC_SRF_RETURN_DONE(fctx);</code></pre></div>


        <p class="p">Use a <code class="ph codeph">DESCRIBE</code> function to define the output
          tuple descriptor of a function that uses the <code class="ph codeph">RETURNS SETOF RECORD</code> clause.
          Use the <code class="ph codeph">GPPC_SRF_RESULT_DESC()</code> macro to get the
          output tuple descriptor of a function that uses the <code class="ph codeph">RETURNS TABLE( ... )</code> clause.</p>

        <p class="p">Refer to the <a class="xref" href="#topic_example_srf">GPPC Set-Returning Function Example</a>
          for a set-returning function code and deployment example.</p>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_tblfunc__py217167" xml:lang="en" lang="en" id="topic_tblfunc">
      <h3 class="title topictitle3" id="topic_tblfunc__py217167">Table Functions</h3>

      <div class="body">
        <p class="p">The GPPC API provides the <code class="ph codeph">GppcAnyTable</code> type to
          pass a table to a function as an input argument, or to return a
          table as a function result.</p>

        <p class="p">Table-related functions and macros provided in the GPPC API include:</p>

        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="topic_tblfunc__in201681" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:40%" /><col style="width:60%" /></colgroup><thead class="thead" style="text-align:left;">
            <tr class="row">
              <th class="entry nocellnorowborder" style="vertical-align:top;" id="d43874e1981">Function/Macro Name</th>

              <th class="entry cell-norowborder" style="vertical-align:top;" id="d43874e1984">Description</th>

            </tr>

          </thead>
<tbody class="tbody">
            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1981 ">GPPC_GETARG_ANYTABLE()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1984 ">Fetch an anytable function argument.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1981 ">GPPC_RETURN_ANYTABLE()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1984 ">Return the table.</td>

            </tr>

            <tr class="row">
              <td class="entry nocellnorowborder" style="vertical-align:top;" headers="d43874e1981 ">GppcAnyTableGetTupleDesc()</td>

              <td class="entry cell-norowborder" style="vertical-align:top;" headers="d43874e1984 ">Fetch the tuple descriptor for the table.</td>

            </tr>

            <tr class="row">
              <td class="entry row-nocellborder" style="vertical-align:top;" headers="d43874e1981 ">GppcAnyTableGetNextTuple()</td>

              <td class="entry cellrowborder" style="vertical-align:top;" headers="d43874e1984 ">Fetch the next row in the table.</td>

            </tr>

          </tbody>
</table>
</div>

      <p class="p">  </p>

      <div class="p">You can use the <code class="ph codeph">GPPC_GETARG_ANYTABLE()</code> macro to
        retrieve a table input argument. When you have access to the table,
        you can examine the tuple descriptor for the table using the
        <code class="ph codeph">GppcAnyTableGetTupleDesc()</code> function. The signature
        of this function is:<pre class="pre codeblock"><code>GppcTupleDesc GppcAnyTableGetTupleDesc(GppcAnyTable t);</code></pre></div>

       <div class="p">For example, to retrieve the tuple descriptor of a table that
         is the first input argument to a function:<pre class="pre codeblock"><code>GppcAnyTable     intbl;
GppcTupleDesc    in_desc;

intbl = GPPC_GETARG_ANYTABLE(0);
in_desc = GppcAnyTableGetTupleDesc(intbl);</code></pre></div>

      <div class="p">The <code class="ph codeph">GppcAnyTableGetNextTuple()</code> function fetches
        the next row from the table. Similarly, to retrieve the next tuple
        from the table above:<pre class="pre codeblock"><code>GppcHeapTuple    ntuple;

ntuple = GppcAnyTableGetNextTuple(intbl);</code></pre></div>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_limits__py217167" xml:lang="en" lang="en" id="topic_limits">
      <h3 class="title topictitle3" id="topic_limits__py217167">Limitations</h3>

      <div class="body">
        <p class="p">The GPPC API does not support the following operators with Greenplum Database version 5.0.x:</p>
<ul class="ul">
          <li class="li">integer || integer</li>

          <li class="li">integer = text</li>

          <li class="li">text &lt; integer</li>

        </ul>

      </div>

    </div>


    <div class="topic nested2" aria-labelledby="topic_samplecode__py217167" xml:lang="en" lang="en" id="topic_samplecode">
      <h3 class="title topictitle3" id="topic_samplecode__py217167">Sample Code</h3>

      <div class="body">
        <p class="p">The <a class="xref" href="https://github.com/greenplum-db/gpdb/tree/master/src/interfaces/gppc/test" target="_blank">gppc test</a>
          directory in the Greenplum Database github repository includes
          sample GPPC code:</p>
<ul class="ul">
          <li class="li"><code class="ph codeph">gppc_demo/</code> - sample code exercising GPPC SPI functions, error reporting, data type argument and return macros, set-returning functions, and encoding functions</li>

          <li class="li"><code class="ph codeph">tabfunc_gppc_demo/</code> - sample code exercising GPPC table and set-returning functions</li>

        </ul>

      </div>

    </div>


  </div>


  <div class="topic nested1" aria-labelledby="topic_build__py217167bbb" xml:lang="en" lang="en" id="topic_build">
      <h2 class="title topictitle2" id="topic_build__py217167bbb">Building a GPPC Shared Library with PGXS</h2>

      <div class="body">
        <p class="p">You compile functions that you write with the GPPC API into one
          or more shared libraries that the Greenplum Database server loads
          on demand.</p>

        <p class="p">You can use the PostgreSQL build extension infrastructure (PGXS)
          to build the source code for your GPPC functions against a Greenplum
          Database installation. This framework automates common build rules
          for simple modules. If you have a more complicated use case, you
          will need to write your own build system.</p>

        <p class="p">To use the PGXS infrastructure to generate a shared library for
          functions that you create with the GPPC API, create a simple
          <code class="ph codeph">Makefile</code> that sets PGXS-specific variables.</p>

        <div class="note"><span class="notetitle">Note:</span> Refer to <a class="xref" href="https://www.postgresql.org/docs/9.4/extend-pgxs.html" target="_blank">Extension Building Infrastructure</a>
          in the PostgreSQL documentation for information about the
          <code class="ph codeph">Makefile</code> variables supported by PGXS.</div>

        <div class="p">For example, the following <code class="ph codeph">Makefile</code> generates
          a shared library named <code class="ph codeph">sharedlib_name.so</code> from
          two C source files named <code class="ph codeph">src1.c</code> and <code class="ph codeph">src2.c</code>:<pre class="pre codeblock"><code>MODULE_big = sharedlib_name
OBJS = src1.o src2.o
PG_CPPFLAGS = -I$(shell $(PG_CONFIG) --includedir)
SHLIB_LINK = -L$(shell $(PG_CONFIG) --libdir) -lgppc

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)</code></pre></div>


        <p class="p"><code class="ph codeph">MODULE_big</code> identifes the base name of the shared
          library generated by the <code class="ph codeph">Makefile</code>.</p>

        <p class="p"><code class="ph codeph">PG_CPPFLAGS</code> adds the Greenplum Database installation
          include directory to the compiler header file search path.</p>

        <p class="p"><code class="ph codeph">SHLIB_LINK</code> adds the Greenplum Database installation
          library directory to the linker search path. This variable also adds
          the GPPC library (<code class="ph codeph">-lgppc</code>) to the link command.</p>

        <p class="p">The <code class="ph codeph">PG_CONFIG</code> and <code class="ph codeph">PGXS</code> variable
          settings and the <code class="ph codeph">include</code> statement are required
          and typically reside in the last three lines of the
          <code class="ph codeph">Makefile</code>.</p>

      </div>

  </div>


  <div class="topic nested1" aria-labelledby="topic_reg__py21716799" xml:lang="en" lang="en" id="topic_reg">
      <h2 class="title topictitle2" id="topic_reg__py21716799">Registering a GPPC Function with Greenplum Database</h2>

      <div class="body">
        <p class="p">Before users can invoke a GPPC function from SQL, you must
          register the function with Greenplum Database.</p>

        <p class="p">Registering a GPPC function involves mapping the GPPC function
          signature to a SQL user-defined function. You define this mapping
          with the <code class="ph codeph">CREATE FUNCTION .. AS </code> command specifying
          the GPPC shared library name. You may choose to use the same name
          or differing names for the GPPC and SQL functions.</p>

        <div class="p">Sample <code class="ph codeph">CREATE FUNCTION ... AS </code> syntax follows:
          <pre class="pre codeblock"><code>CREATE FUNCTION &lt;sql_function_name&gt;(&lt;arg&gt;[, ...]) RETURNS &lt;return_type&gt;
  AS '&lt;shared_library_path&gt;'[, '&lt;gppc_function_name&gt;']
LANGUAGE C STRICT [WITH (DESCRIBE=&lt;describe_function&gt;)];</code></pre></div>

         <p class="p">You may omit the shared library <code class="ph codeph">.so</code> extension
           when you specify <code class="ph codeph"><var class="keyword varname">shared_library_path</var></code>.</p>

        <div class="p">The following command registers the example <code class="ph codeph">add_int4s()</code>
          function referenced earlier in this topic to a SQL UDF named
          <code class="ph codeph">add_two_int4s_gppc()</code> if the GPPC function was compiled
          and linked in a shared library named <code class="ph codeph">gppc_try.so</code>:
          <pre class="pre codeblock"><code>CREATE FUNCTION add_two_int4s_gppc(int4, int4) RETURNS int8
  AS 'gppc_try.so', 'add_int4s'
LANGUAGE C STRICT;</code></pre></div>

      </div>


  <div class="topic nested2" aria-labelledby="topic_dynload__py217167bx" xml:lang="en" lang="en" id="topic_dynload">
    <h3 class="title topictitle3" id="topic_dynload__py217167bx">About Dynamic Loading</h3>

    <div class="body">
      <p class="p">You specify the name of the GPPC shared library in the SQL
        <code class="ph codeph">CREATE FUNCTION ... AS</code> command to register a GPPC
        function in the shared library with Greenplum Database. The Greenplum
        Database dynamic loader loads a GPPC shared library file into memory
        the first time that a user invokes a user-defined function linked in
        that shared library. If you do not provide an absolute path to the
        shared library in the <code class="ph codeph">CREATE FUNCTION ... AS</code>
        command, Greenplum Database attempts to locate the library using these
        ordered steps:</p>
<ol class="ol">
        <li class="li">If the shared library file path begins with the string
          <code class="ph codeph">$libdir</code>, Greenplum Database looks for the file
          in the PostgreSQL package library directory. Run the
          <code class="ph codeph">pg_config --pkglibdir</code> command to determine the
          location of this directory.</li>

        <li class="li">If the shared library file name is specified without a directory
          prefix, Greenplum Database searches for the file in the directory
          identified by the <code class="ph codeph">dynamic_library_path</code> server
          configuration parameter value.</li>

        <li class="li">The current working directory.</li>
</ol>

    </div>

  </div>

  </div>

  <div class="topic nested1" aria-labelledby="topic_deploy__py21716799" xml:lang="en" lang="en" id="topic_deploy">
      <h2 class="title topictitle2" id="topic_deploy__py21716799">Packaging and Deployment Considerations</h2>

      <div class="body">
        <p class="p">You must package the GPPC shared library and SQL function
          registration script in a form suitable for deployment by the
          Greenplum Database administrator in the Greenplum cluster.
          Provide specific deployment instructions for your GPPC package.</p>

        <p class="p">When you construct the package and deployment instructions, take
          into account the following:</p>
<ul class="ul">
          <li class="li">Consider providing a shell script or program that the Greenplum
            Database administrator runs to both install the shared library to
            the desired file system location and register the GPPC functions.</li>

          <li class="li">The GPPC shared library must be installed to the same file
            system location on the master host and on every segment host in the
            Greenplum Database cluster.</li>

          <li class="li">The <code class="ph codeph">gpadmin</code> user must have permission to
            traverse the complete file system path to the GPPC shared 
            library file.</li>

         <li class="li">The file system location of your GPPC shared library after it
           is installed in the Greenplum Database deployment determines how
           you reference the shared library when you register a function in
           the library with the <code class="ph codeph">CREATE FUNCTION ... AS</code>
           command.</li>

          <li class="li"> Create a <code class="ph codeph">.sql</code> script file that registers
           a SQL UDF for each GPPC function in your GPPC shared library.
           The functions that you create in the <code class="ph codeph">.sql</code>
           registration script must reference the deployment location of the
           GPPC shared library. Include this script in your GPPC deployment package.</li>

          <li class="li">Document the instructions for running your GPPC package deployment
             script, if you provide one.</li>

          <li class="li">Document the instructions for installing the GPPC shared library
            if you do not include this task in a package deployment script.</li>

          <li class="li">Document the instructions for installing and running the function
            registration script if you do not include this task in a package
            deployment script.</li>

        </ul>

      </div>

  </div>

  <div class="topic nested1" aria-labelledby="topic_example_text__py217167" xml:lang="en" lang="en" id="topic_example_text">
    <h2 class="title topictitle2" id="topic_example_text__py217167">GPPC Text Function Example</h2>

    <div class="body">
      <p class="p">In this example, you develop, build, and deploy a GPPC shared library
        and register and run a GPPC function named <code class="ph codeph">concat_two_strings</code>.
        This function uses the GPPC API to concatenate two string arguments
        and return the result.</p>

      <p class="p">You will develop the GPPC function on your Greenplum Database master
        host. Deploying the GPPC shared library that you create in this
        example requires administrative access to your Greenplum Database
        cluster.</p>

      <p class="p">Perform the following procedure to run the example:</p>
<ol class="ol">
        <li class="li">Log in to the Greenplum Database master host and set up your environment. For example:<pre class="pre codeblock"><code>$ ssh gpadmin@&lt;gpmaster&gt;
gpadmin@gpmaster$ . /usr/local/greenplum-db/greenplum_path.sh</code></pre></li>

        <li class="li">Create a work directory and navigate to the new directory. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ mkdir gppc_work
gpadmin@gpmaster$ cd gppc_work</code></pre></li>

        <li class="li">Prepare a file for GPPC source code by opening the file in the editor of your choice. For example, to open a file named <code class="ph codeph">gppc_concat.c</code> using <code class="ph codeph">vi</code>:<pre class="pre codeblock"><code>gpadmin@gpmaster$ vi gppc_concat.c</code></pre></li>

        <li class="li">Copy/paste the following code into the file:<pre class="pre codeblock"><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include "gppc.h"

// make the function SQL-invokable
GPPC_FUNCTION_INFO(concat_two_strings);

// declare the function
GppcDatum concat_two_strings(GPPC_FUNCTION_ARGS);

GppcDatum
concat_two_strings(GPPC_FUNCTION_ARGS)
{
    // retrieve the text input arguments
    GppcText arg0 = GPPC_GETARG_TEXT(0);
    GppcText arg1 = GPPC_GETARG_TEXT(1);

    // determine the size of the concatenated string and allocate
    // text memory of this size
    size_t arg0_len = GppcGetTextLength(arg0);
    size_t arg1_len = GppcGetTextLength(arg1);
    GppcText retstring = GppcAllocText(arg0_len + arg1_len);

    // construct the concatenated return string
    memcpy(GppcGetTextPointer(retstring), GppcGetTextPointer(arg0), arg0_len);
    memcpy(GppcGetTextPointer(retstring) + arg0_len, GppcGetTextPointer(arg1), arg1_len);

    GPPC_RETURN_TEXT( retstring );
}</code></pre><p class="p">The code declares and implements the <code class="ph codeph">concat_two_strings()</code> function. It uses GPPC data types, macros, and functions to get the function arguments, allocate memory for the concatenated string, copy the arguments into the new string, and return the result.</p>
</li>

        <li class="li">Save the file and exit the editor.</li>

        <li class="li">Open a file named <code class="ph codeph">Makefile</code> in the editor of your choice. Copy/paste the following text into the file:<pre class="pre codeblock"><code>MODULE_big = gppc_concat
OBJS = gppc_concat.o

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)

PG_CPPFLAGS = -I$(shell $(PG_CONFIG) --includedir)
SHLIB_LINK = -L$(shell $(PG_CONFIG) --libdir) -lgppc
include $(PGXS)</code></pre></li>

        <li class="li">Save the file and exit the editor.</li>

        <li class="li">Build a GPPC shared library for the <code class="ph codeph">concat_two_strings()</code> function. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ make all</code></pre><p class="p">The <code class="ph codeph">make</code> command generates a shared library file named <code class="ph codeph">gppc_concat.so</code> in the current working directory.</p>
</li>

        <li class="li">Copy the shared library to your Greenplum Database installation. You must have Greenplum Database administrative privileges to copy the file. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ cp gppc_concat.so /usr/local/greenplum-db/lib/postgresql/</code></pre></li>

        <li class="li">Copy the shared library to every host in your Greenplum Database installation. For example, if <code class="ph codeph">seghostfile</code> contains a list, one-host-per-line, of the segment hosts in your Greenplum Database cluster:<pre class="pre codeblock"><code>gpadmin@gpmaster$ gpscp -v -f seghostfile /usr/local/greenplum-db/lib/postgresql/gppc_concat.so =:/usr/local/greenplum-db/lib/postgresql/gppc_concat.so</code></pre></li>

        <li class="li">Open a <code class="ph codeph">psql</code> session. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ psql -d testdb</code></pre></li>

        <li class="li">Register the GPPC function named <code class="ph codeph">concat_two_strings()</code> with Greenplum Database, For example, to map the Greenplum Database function <code class="ph codeph">concat_with_gppc()</code> to the GPPC <code class="ph codeph">concat_two_strings()</code> function:<pre class="pre codeblock"><code>testdb=# CREATE FUNCTION concat_with_gppc(text, text) RETURNS text
  AS 'gppc_concat', 'concat_two_strings'
LANGUAGE C STRICT;</code></pre></li>

        <li class="li">Run the <code class="ph codeph">concat_with_gppc()</code> function. For example:<pre class="pre codeblock"><code>testdb=# SELECT concat_with_gppc( 'happy', 'monday' );
 concat_with_gppc
------------------
 happymonday
(1 row)
</code></pre></li>

      </ol>

    </div>

  </div>

  <div class="topic nested1" aria-labelledby="topic_example_srf__py217167" xml:lang="en" lang="en" id="topic_example_srf">
    <h2 class="title topictitle2" id="topic_example_srf__py217167">GPPC Set-Returning Function Example</h2>

    <div class="body">
      <p class="p">In this example, you develop, build, and deploy a GPPC shared library.
        You also create and run a <code class="ph codeph">.sql</code> registration script
        for a GPPC function named <code class="ph codeph">return_tbl()</code>. This function
        uses the GPPC API to take an input table with an integer and a text
        column, determine if the integer column is greater than 13, and
        returns a result table with the input integer column and a boolean
        column identifying whether or not the integer is greater than 13.
        <code class="ph codeph">return_tbl()</code> utilizes GPPC API reporting and SRF
        functions and macros.</p>

      <p class="p">You will develop the GPPC function on your Greenplum Database master
        host. Deploying the GPPC shared library that you create in this
        example requires administrative access to your Greenplum Database
        cluster.</p>

      <p class="p">Perform the following procedure to run the example:</p>
<ol class="ol">
        <li class="li">Log in to the Greenplum Database master host and set up your environment. For example:<pre class="pre codeblock"><code>$ ssh gpadmin@&lt;gpmaster&gt;
gpadmin@gpmaster$ . /usr/local/greenplum-db/greenplum_path.sh</code></pre></li>

        <li class="li">Create a work directory and navigate to the new directory. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ mkdir gppc_work
gpadmin@gpmaster$ cd gppc_work</code></pre></li>

        <li class="li">Prepare a source file for GPPC code by opening the file in the editor of your choice. For example, to open a file named <code class="ph codeph">gppc_concat.c</code> using <code class="ph codeph">vi</code>:<pre class="pre codeblock"><code>gpadmin@gpmaster$ vi gppc_rettbl.c</code></pre></li>

        <li class="li">Copy/paste the following code into the file:<pre class="pre codeblock"><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include "gppc.h"

// initialize the logging level
GppcReportLevel level = GPPC_INFO;

// make the function SQL-invokable and declare the function
GPPC_FUNCTION_INFO(return_tbl);
GppcDatum return_tbl(GPPC_FUNCTION_ARGS);

GppcDatum
return_tbl(GPPC_FUNCTION_ARGS)
{
    GppcFuncCallContext	fctx;
    GppcAnyTable	intbl;
    GppcHeapTuple	intuple;
    GppcTupleDesc	in_tupdesc, out_tupdesc;
    GppcBool  		resbool = false;
    GppcDatum  		result, boolres, values[2];
    bool		nulls[2] = {false, false};

    // single input argument - the table
    intbl = GPPC_GETARG_ANYTABLE(0);

    // set the function context
    if (GPPC_SRF_IS_FIRSTCALL()) {
        fctx = GPPC_SRF_FIRSTCALL_INIT();
    }
    fctx = GPPC_SRF_PERCALL_SETUP();

    // get the tuple descriptor for the input table
    in_tupdesc  = GppcAnyTableGetTupleDesc(intbl);

    // retrieve the next tuple
    intuple = GppcAnyTableGetNextTuple(intbl);
    if( intuple == NULL ) {
      // no more tuples, conclude
      GPPC_SRF_RETURN_DONE(fctx);
    }

    // get the output tuple descriptor and verify that it is
    // defined as we expect
    out_tupdesc = GPPC_SRF_RESULT_DESC();
    if (GppcTupleDescNattrs(out_tupdesc) != 2                ||
        GppcTupleDescAttrType(out_tupdesc, 0) != GppcOidInt4 ||
        GppcTupleDescAttrType(out_tupdesc, 1) != GppcOidBool) {
        GppcReport(GPPC_ERROR, "INVALID out_tupdesc tuple");
    }

    // log the attribute names of the output tuple descriptor
    GppcReport(level, "output tuple descriptor attr0 name: %s", GppcTupleDescAttrName(out_tupdesc, 0));
    GppcReport(level, "output tuple descriptor attr1 name: %s", GppcTupleDescAttrName(out_tupdesc, 1));

    // retrieve the attribute values by name from the tuple
    bool text_isnull, int_isnull;
    GppcDatum intdat = GppcGetAttributeByName(intuple, "id", &amp;int_isnull);
    GppcDatum textdat = GppcGetAttributeByName(intuple, "msg", &amp;text_isnull);

    // convert datum to specific type
    GppcInt4 intarg = GppcDatumGetInt4(intdat);
    GppcReport(level, "id: %d", intarg);
    GppcReport(level, "msg: %s", GppcTextGetCString(GppcDatumGetText(textdat)));

    // perform the &gt;13 check on the integer
    if( !int_isnull &amp;&amp; (intarg &gt; 13) ) {
        // greater than 13?
        resbool = true;
        GppcReport(level, "id is greater than 13!");
    }

    // values are datums; use integer from the tuple and
    // construct the datum for the boolean return
    values[0] = intdat;
    boolres = GppcBoolGetDatum(resbool);
    values[1] = boolres;

    // build a datum tuple and return
    result = GppcBuildHeapTupleDatum(out_tupdesc, values, nulls);
    GPPC_SRF_RETURN_NEXT(fctx, result);

}</code></pre><p class="p">The code declares and implements the <code class="ph codeph">return_tbl()</code> function. It uses GPPC data types, macros, and functions to fetch the function arguments, examine tuple descriptors, build the return tuple, and return the result. The function also uses the SRF macros to keep track of the tuple context across function calls.</p>
</li>

        <li class="li">Save the file and exit the editor.</li>

        <li class="li">Open a file named <code class="ph codeph">Makefile</code> in the editor of your choice. Copy/paste the following text into the file:<pre class="pre codeblock"><code>MODULE_big = gppc_rettbl
OBJS = gppc_rettbl.o

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)

PG_CPPFLAGS = -I$(shell $(PG_CONFIG) --includedir)
SHLIB_LINK = -L$(shell $(PG_CONFIG) --libdir) -lgppc
include $(PGXS)</code></pre></li>

        <li class="li">Save the file and exit the editor.</li>

        <li class="li">Build a GPPC shared library for the <code class="ph codeph">return_tbl()</code> function. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ make all</code></pre><p class="p">The <code class="ph codeph">make</code> command generates a shared library file named <code class="ph codeph">gppc_rettbl.so</code> in the current working directory.</p>
</li>

        <li class="li">Copy the shared library to your Greenplum Database installation. You must have Greenplum Database administrative privileges to copy the file. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ cp gppc_rettbl.so /usr/local/greenplum-db/lib/postgresql/</code></pre><p class="p">This command copies the shared library to <code class="ph codeph">$libdir</code></p>
</li>

        <li class="li">Copy the shared library to every host in your Greenplum Database installation. For example, if <code class="ph codeph">seghostfile</code> contains a list, one-host-per-line, of the segment hosts in your Greenplum Database cluster:<pre class="pre codeblock"><code>gpadmin@gpmaster$ gpscp -v -f seghostfile /usr/local/greenplum-db/lib/postgresql/gppc_rettbl.so =:/usr/local/greenplum-db/lib/postgresql/gppc_rettbl.so</code></pre></li>

        <li class="li">Create a <code class="ph codeph">.sql</code> file to register the GPPC <code class="ph codeph">return_tbl()</code> function. Open a file named <code class="ph codeph">gppc_rettbl_reg.sql</code> in the editor of your choice.</li>

        <li class="li">Copy/paste the following text into the file:<pre class="pre codeblock"><code>CREATE FUNCTION rettbl_gppc(anytable) RETURNS TABLE(id int4, thirteen bool)
  AS 'gppc_rettbl', 'return_tbl'
LANGUAGE C STRICT;</code></pre></li>

        <li class="li">Register the GPPC function by running the script you just created. For example, to register the function in a database named <code class="ph codeph">testdb</code>:<pre class="pre codeblock"><code>gpadmin@gpmaster$ psql -d testdb -f gppc_rettbl_reg.sql</code></pre></li>

        <li class="li">Open a <code class="ph codeph">psql</code> session. For example:<pre class="pre codeblock"><code>gpadmin@gpmaster$ psql -d testdb</code></pre></li>

        <li class="li">Create a table with some test data. For example:<pre class="pre codeblock"><code>CREATE TABLE gppc_testtbl( id int, msg text );
INSERT INTO gppc_testtbl VALUES (1, 'f1');
INSERT INTO gppc_testtbl VALUES (7, 'f7');
INSERT INTO gppc_testtbl VALUES (10, 'f10');
INSERT INTO gppc_testtbl VALUES (13, 'f13');
INSERT INTO gppc_testtbl VALUES (15, 'f15');
INSERT INTO gppc_testtbl VALUES (17, 'f17');</code></pre></li>

        <li class="li">Run the <code class="ph codeph">rettbl_gppc()</code> function. For example:<pre class="pre codeblock"><code>testdb=# SELECT * FROM rettbl_gppc(TABLE(SELECT * FROM gppc_testtbl));
 id | thirteen 
----+----------
  1 | f
  7 | f
 13 | f
 15 | t
 17 | t
 10 | f
(6 rows)
</code></pre></li>

      </ol>

    </div>

  </div>

</body>
</html>