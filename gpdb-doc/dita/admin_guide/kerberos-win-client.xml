<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Composite//EN" "ditabase.dtd">
<topic id="topic1">
  <title>Configuring Kerberos For Windows Clients</title>
  <shortdesc>You can configure Microsoft Windows client applications to connect to a Greenplum
    Database system that is configured to authenticate with Kerberos.</shortdesc>
  <body>
    <p>When a Greenplum Database system is configured to authenticate with
      Kerberos, you can configure Kerberos authentication for the Greenplum
      Database client utilities <codeph>gpload</codeph> and
        <codeph>psql</codeph> on a Microsoft Windows system. The Greenplum
      Database clients authenticate with Kerberos directly.</p>
    <p>This section contains the following information.</p>
    <p>
      <ul id="ul_ask_2r1_cw">
        <li><xref href="#topic_win_kerberos_install" format="dita"/></li>
        <li><xref href="#topic_win_psql_kerb" format="dita"/></li>
        <li><xref href="#topic_win_gpload_kerb" format="dita"/></li>
        <li><xref href="#topic_win_keytab" format="dita"/></li>
        <li><xref href="#topic_win_kerberos_issues" format="dita"/></li>
      </ul></p>
    <p>These topics assume that the Greenplum Database system is configured to authenticate with
      Kerberos. For information about configuring Greenplum Database with Kerberos
      authentication, refer to <xref href="kerberos.xml#topic1"/>.</p>
  </body>
  <topic id="topic_win_kerberos_install">
    <title>Installing and Configuring Kerberos on a Windows System</title>
    <body>
      <p>The <codeph>kinit</codeph>, <codeph>kdestroy</codeph>, and <codeph>klist</codeph> MIT
        Kerberos Windows client programs and supporting libraries are installed on your system
        when you install the Greenplum Database Client and Load Tools package:</p>
          <ul>
            <li><codeph>kinit</codeph> - generate a Kerberos ticket </li>
            <li><codeph>kdestroy</codeph> - destroy active Kerberos tickets </li>
            <li><codeph>klist</codeph> - list Kerberos tickets</li>
          </ul>
      <p>You must set up Kerberos configuration on the Windows client to authenticate with
        Greenplum Database:</p>
      <ol>
        <li>Copy the Kerberos configuration file <codeph>/etc/krb5.conf</codeph> from the
        Greenplum Database master to the Windows system, rename it to
        <codeph>krb5.ini</codeph>, and place it in the
        default Kerberos location on the Windows
        system, <codeph>C:\ProgramData\MIT\Kerberos5\krb5.ini</codeph>. This directory may be hidden.
        You may also choose to place the <codeph>/etc/krb5.ini</codeph> file in a custom
        location.</li>
      <li>Locate the <codeph>[libdefaults]</codeph> section of the <codeph>krb5.ini</codeph>
        file, and remove the entry identifying the location of the Kerberos credentials
        cache file, <codeph>default_ccache_name</codeph>.
      <p>This is an example configuration file with <codeph>default_ccache_name</codeph> removed.
        The <codeph>[logging]</codeph> section is also removed. </p>
      <codeblock>[libdefaults]
 debug = true
 default_etypes = aes256-cts-hmac-sha1-96
 default_realm = EXAMPLE.LOCAL
 dns_lookup_realm = false
 dns_lookup_kdc = false
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true

[realms]
 EXAMPLE.LOCAL = {
  kdc =bocdc.example.local
  admin_server = bocdc.example.local
 }

[domain_realm]
 .example.local = EXAMPLE.LOCAL
 example.local = EXAMPLE.LOCAL</codeblock></li>
      <li>Set up the Kerberos credential cache file. On the Windows system, set the environment
        variable <codeph>KRB5CCNAME</codeph> to specify the file system location of the cache
        file. The file must be named <codeph>krb5cache</codeph>. This location identifies a
        file, not a directory, and should be unique to each login on the server.
        When you set <codeph>KRB5CCNAME</codeph>, you can specify the value in either
        a local user environment or within a session. For example, the following command
        sets <codeph>KRB5CCNAME</codeph> in the session:
        <codeblock>set KRB5CCNAME=%USERPROFILE%\krb5cache</codeblock></li>
      <li>Obtain your Kerberos principal and password or keytab file from your system administrator.</li>
      <li>Generate a Kerberos ticket using a password or a keytab. For example, to generate a
        ticket using a password:
        <codeblock>kinit [&lt;principal>]</codeblock>
        <p>To generate a ticket using a keytab (as described in <xref href="#topic_win_keytab" format="dita"/>):
          <codeblock>kinit -k -t &lt;keytab_filepath> [&lt;principal>]</codeblock></p></li>
      <li>Set up the Greenplum clients environment:
        <codeblock>"c:\Program Files\Greenplum\greenplum-clients\greenplum_clients_path.bat"</codeblock></li>
      </ol>
    </body>
  </topic>
  <topic id="topic_win_psql_kerb">
    <title>Running the psql Utility</title>
    <body>
      <p>After you configure Kerberos and generate the Kerberos ticket on a Windows system,
        you can run the Greenplum Database command line client <codeph>psql</codeph>.</p>
      <p>If you get warnings indicating that the Console code page differs from Windows code page,
        you can run the Windows utility <codeph>chcp</codeph> to change the code page. This is an
        example of the warning and fix:</p>
      <codeblock>psql -h prod1.example.local warehouse
psql (9.4.20)
WARNING: Console code page (850) differs from Windows code page (1252)
 8-bit characters might not work correctly. See psql reference
 page "Notes for Windows users" for details.
Type "help" for help.

warehouse=# \q

chcp 1252
Active code page: 1252

psql -h prod1.example.local warehouse
psql (9.4.20)
Type "help" for help.</codeblock>
    </body>
  </topic>
  <topic id="topic_win_keytab">
    <title>Creating a Kerberos Keytab File</title>
    <body>
      <p>You can create and use a Kerberos <codeph>keytab</codeph> file to avoid entering a
        password at the command line or listing a password in a script file when you connect
        to a Greenplum Database system. You can create a keytab file with the Java JRE keytab
        utility <codeph>ktab</codeph>. If you use AES256-CTS-HMAC-SHA1-96
              encryption, you need to download and install the Java extension <cite>Java
                Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for
                JDK/JRE</cite> from Oracle. This command creates the keytab file
                <codeph>svcPostgresProd1.keytab</codeph>.</p>
      <note>You must enter the password to create a keytab file. The password is visible
         onscreen as you enter it.</note>
      <p>This example runs the Java <codeph>ktab.exe</codeph> program to create a keytab file
          (<codeph>-a</codeph> option) and list the keytab name and entries (<codeph>-l</codeph>
        <codeph>-e</codeph>
        <codeph>-t</codeph> options).</p>
      <codeblock>C:\Users\dev1>"\Program Files\Java\jre1.8.0_77\bin"\ktab -a dev1
Password for dev1@EXAMPLE.LOCAL:<varname>your_password</varname>
Done!
Service key for dev1 is saved in C:\Users\dev1\krb5.keytab

C:\Users\dev1>"\Program Files\Java\jre1.8.0_77\bin"\ktab -l -e -t
Keytab name: C:\Users\dev1\krb5.keytab
KVNO Timestamp Principal
---- -------------- ------------------------------------------------------
 4 13/04/16 19:14 dev1@EXAMPLE.LOCAL (18:AES256 CTS mode with HMAC SHA1-96)
 4 13/04/16 19:14 dev1@EXAMPLE.LOCAL (17:AES128 CTS mode with HMAC SHA1-96)
 4 13/04/16 19:14 dev1@EXAMPLE.LOCAL (16:DES3 CBC mode with SHA1-KD)
 4 13/04/16 19:14 dev1@EXAMPLE.LOCAL (23:RC4 with HMAC)</codeblock>
      <p>You can then generate a Kerberos ticket using a keytab with the following command:</p>
      <codeblock>kinit -kt dev1.keytab dev1</codeblock>
<p>or</p>
<codeblock>kinit -kt %USERPROFILE%\krb5.keytab dev1</codeblock>
    </body>
  </topic>
  <topic id="topic_win_gpload_kerb">
    <title>Example gpload YAML File</title>
    <body>
      <p>When you initiate a <codeph>gpload</codeph> job to a Greenplum Database
        system using Kerberos authentication, you omit the <codeph>USER:</codeph>
        property and value from the YAML control file.</p>
      <p>This example <codeph>gpload</codeph> YAML control file named
        <codeph>test.yaml</codeph> does not include a <codeph>USER:</codeph> entry:</p>
      <codeblock>---
VERSION: 1.0.0.1
DATABASE: warehouse
HOST: prod1.example.local
PORT: 5432

GPLOAD:
   INPUT:
    - SOURCE:
         PORT_RANGE: [18080,18080]
         FILE:
           - /Users/dev1/Downloads/test.csv
    - FORMAT: text
    - DELIMITER: ','
    - QUOTE: '"'
    - ERROR_LIMIT: 25
    - LOG_ERRORS: true
   OUTPUT:
    - TABLE: public.test
    - MODE: INSERT
   PRELOAD:
    - REUSE_TABLES: true</codeblock>
      <p>These commands run <codeph>kinit</codeph> using a keytab file, run
          <codeph>gpload.bat</codeph> with the
          <codeph>test.yaml</codeph> file, and then display successful <codeph>gpload</codeph>
        output.</p>
      <codeblock>kinit -kt %USERPROFILE%\krb5.keytab dev1

gpload.bat -f test.yaml
2016-04-10 16:54:12|INFO|gpload session started 2016-04-10 16:54:12
2016-04-10 16:54:12|INFO|started gpfdist -p 18080 -P 18080 -f "/Users/dev1/Downloads/test.csv" -t 30
2016-04-10 16:54:13|INFO|running time: 0.23 seconds
2016-04-10 16:54:13|INFO|rows Inserted = 3
2016-04-10 16:54:13|INFO|rows Updated = 0
2016-04-10 16:54:13|INFO|data formatting errors = 0
2016-04-10 16:54:13|INFO|gpload succeeded</codeblock>
    </body>
  </topic>
  <topic id="topic_win_kerberos_issues">
    <title>Issues and Possible Solutions</title>
    <body>
      <ul id="ul_tkb_hds_wv">
        <li>This message indicates that Kerberos cannot find your Kerberos credentials cache
            file:<codeblock>Credentials cache I/O operation failed XXX
(Kerberos error 193)
krb5_cc_default() failed</codeblock><p>To
            ensure that Kerberos can find the file, set the environment variable
              <codeph>KRB5CCNAME</codeph> and run
          <codeph>kinit</codeph>.</p><codeblock>set KRB5CCNAME=%USERPROFILE%\krb5cache
kinit</codeblock></li>
        <li>This <codeph>kinit</codeph> message indicates that the <codeph>kinit -k -t</codeph>
          command could not find the
            keytab.<codeblock>kinit: Generic preauthentication failure while getting initial credentials</codeblock><p>Confirm
            that the full path and filename for the Kerberos keytab file is correct.</p></li>
      </ul>
    </body>
  </topic>
</topic>
