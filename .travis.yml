## ======================================================================
##   ____ ____  ____  ____     ____                         
##  / ___|  _ \|  _ \| __ )   / ___|_   _ _ __  _ __  _   _ 
## | |  _| |_) | | | |  _ \  | |  _| | | | '_ \| '_ \| | | |
## | |_| |  __/| |_| | |_) | | |_| | |_| | | | | | | | |_| |
##  \____|_|   |____/|____/   \____|\__,_|_| |_|_| |_|\__, |
##                                                    |___/ 
## ----------------------------------------------------------------------
## Travis CI build script for GPDB Open Source Project.
## 
## Reference:
##   o Travis CI Docs: http://docs.travis-ci.com
## ----------------------------------------------------------------------
##
## This project builds the core Greenplum Database Open Source
## project.
##
## ======================================================================

os:
  - linux
  - osx

language: c
sudo: false

git:
  submodules: false

## ----------------------------------------------------------------------
## Build tools
## ----------------------------------------------------------------------

compiler:
  - gcc

python:
  - "2.7"

## ----------------------------------------------------------------------
## Install supporting Python modules
## ----------------------------------------------------------------------

install:
  - pip install --user --upgrade pip
  - pip install --user --pre psi
  - pip install --user lockfile
  - pip install --user paramiko
  - pip install --user setuptools
  - pip install --user epydoc

## ----------------------------------------------------------------------
## Build APR & APR-UTIL used to build gpfdist
## ----------------------------------------------------------------------

env:
  - APR=apr-1.5.2
    APR_UTIL=apr-util-1.5.4
    APR_TAR=${APR}.tar.gz
    APR_UTIL_TAR=${APR_UTIL}.tar.gz

before_script:
  - export PATH=${TRAVIS_BUILD_DIR}/tools/bin:$PATH
  - cd ${TRAVIS_BUILD_DIR}
  - wget http://ftp.jaist.ac.jp/pub/apache/apr/${APR_TAR}
  - wget http://ftp.jaist.ac.jp/pub/apache/apr/${APR_UTIL_TAR}
  - tar xf ${APR_TAR}
  - tar xf ${APR_UTIL_TAR}
  - cd ${TRAVIS_BUILD_DIR}/${APR}
  - ./configure --prefix=${TRAVIS_BUILD_DIR}/tools
  - make install
  - cd ${TRAVIS_BUILD_DIR}/${APR_UTIL}
  - ./configure --prefix=${TRAVIS_BUILD_DIR}/tools --with-apr=${TRAVIS_BUILD_DIR}/${APR}
  - make install

## ----------------------------------------------------------------------
## Perform build:
##   GPDB
##   gpmapreduce
##   orafce
##   gpfdist
## ----------------------------------------------------------------------

script:
  - cd ${TRAVIS_BUILD_DIR}
  - ./configure --with-openssl --with-ldap --with-libcurl --prefix=${TRAVIS_BUILD_DIR}/gpsql --with-apr-config=${TRAVIS_BUILD_DIR}/tools/bin/apr-1-config

  - make
  - make install
  - source ${TRAVIS_BUILD_DIR}/gpsql/greenplum_path.sh
  - cd ${TRAVIS_BUILD_DIR}/gpAux/extensions/orafce
  - make install USE_PGXS=1
  - cd ${TRAVIS_BUILD_DIR}/gpAux/extensions/gpmapreduce
  - make install
  - postgres --version
  - initdb --version
  - createdb --version
  - psql --version
  - gpmigrator --version
  - gpssh --version
  - gpmapreduce --version
  - gpfdist --version
  - source ${TRAVIS_BUILD_DIR}/gpsql/greenplum_path.sh
  - cd ${TRAVIS_BUILD_DIR}/gpAux/gpdemo
  - make
  - cat ~/gpAdminLogs/*.log
  - createdb
  - cd ${TRAVIS_BUILD_DIR}
  - make installcheck-good 

## ----------------------------------------------------------------------
## Before install 
## install libevent 
## ----------------------------------------------------------------------
before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then 
       brew install libevent          ; 
       sysctl -w kern.sysv.shmmax=2147483648;
       sysctl -w kern.sysv.shmmin=1;
       sysctl -w kern.sysv.shmmni=64;
       sysctl -w kern.sysv.shmseg=16;
       sysctl -w kern.sysv.shmall=524288;
       sysctl -w kern.maxfiles=65535;
       sysctl -w kern.maxfilesperproc=65535;
       sysctl -w net.inet.tcp.msl=60;
    else
       sysctl -w kernel.shmmax=500000000;
       sysctl -w kernel.shmmni=4096;
       sysctl -w kernel.shmall=4000000000;
       sysctl -w kernel.sysrq=1;
       sysctl -w kernel.core_uses_pid=1;
       sysctl -w kernel.sem=250 512000 100 2048;
       sysctl -w kernel.sysrq=1;
       sysctl -w kernel.core_uses_pid=1;
       sysctl -w kernel.msgmnb=65536;
       sysctl -w kernel.msgmax=65536;
       sysctl -w kernel.msgmni=2048;
       sysctl -w net.ipv4.tcp_syncookies=1;
       sysctl -w net.ipv4.ip_forward=0;
       sysctl -w net.ipv4.conf.default.accept_source_route=0;
       sysctl -w net.ipv4.tcp_tw_recycle =1;
       sysctl -w net.ipv4.tcp_max_syn_backlog=4096;
       sysctl -w net.ipv4.conf.all.arp_filter=1;
       sysctl -w net.ipv4.ip_local_port_range=1025 65535;
       sysctl -w net.core.netdev_max_backlog=10000;
       sysctl -w net.core.rmem_max=2097152;
       sysctl -w net.core.wmem_max=2097152;
       sysctl -w vm.overcommit_memory=2;
    fi

## ----------------------------------------------------------------------
## Notification
## ----------------------------------------------------------------------
notifications:
  email:
    recipients:
      - releng@pivotal.io
    on_success: change
    on_failure: always
