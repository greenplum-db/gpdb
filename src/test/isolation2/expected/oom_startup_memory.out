-- OOM should be raised when there are too many idle processes.
--
-- We have below assumptions in the tests:
-- - number of primary segments: 3;
-- - the startup memory cost for a postgres process: 8MB ~ 14MB;
-- - per query limit: 20MB;
-- - per segment limit: 60MB;

-- start_matchsubs
--
-- m/DETAIL:  Per-query VM protect limit reached: current limit is \d+ kB, requested \d+ bytes, available \d+ MB/
-- s/\d+/XXX/g
--
-- m/DETAIL:  VM Protect failed to allocate \d+ bytes, \d+ MB available/
-- s/\d+/XXX/g
--
-- m/(seg\d+ \d+.\d+.\d+.\d+:\d+)/
-- s/(.*)/(seg<ID> IP:PORT)/
--
-- end_matchsubs

--
-- To reach the per query limit we need at least 3 slices in one query.
--

1: select * from gp_dist_random('gp_id') t1 join gp_dist_random('gp_id') t2 using(gpname) join gp_dist_random('gp_id') t3 using(gpname) join gp_dist_random('gp_id') t4 using(gpname) ;
ERROR:  failed to acquire resources on one or more segments
DETAIL:  FATAL:  Out of memory
DETAIL:  Per-query VM protect limit reached: current limit is 20480 kB, requested 8388608 bytes, available 0 MB
 (seg0 192.168.99.100:25432)
1q: ... <quitting>

--
-- To reach the per segment limit we need at least 8 concurrent sessions.
--

-- However the per segment limit is not enforced on QD, so below QD-only
-- sessions could all run successfully.
1: select 1;
 ?column? 
----------
 1        
(1 row)
2: select 1;
 ?column? 
----------
 1        
(1 row)
3: select 1;
 ?column? 
----------
 1        
(1 row)
4: select 1;
 ?column? 
----------
 1        
(1 row)
5: select 1;
 ?column? 
----------
 1        
(1 row)
6: select 1;
 ?column? 
----------
 1        
(1 row)
7: select 1;
 ?column? 
----------
 1        
(1 row)
8: select 1;
 ?column? 
----------
 1        
(1 row)

-- The per segment limit should be reached on one or more QEs in below
-- sessions, we only care about the last one.
-- start_ignore
1: set gp_vmem_idle_resource_timeout to '1h';
SET
2: set gp_vmem_idle_resource_timeout to '1h';
SET
3: set gp_vmem_idle_resource_timeout to '1h';
SET
4: set gp_vmem_idle_resource_timeout to '1h';
SET
5: set gp_vmem_idle_resource_timeout to '1h';
SET
6: set gp_vmem_idle_resource_timeout to '1h';
SET
7: set gp_vmem_idle_resource_timeout to '1h';
SET
-- end_ignore
8: set gp_vmem_idle_resource_timeout to '1h';
ERROR:  failed to acquire resources on one or more segments
DETAIL:  FATAL:  Out of memory
DETAIL:  VM Protect failed to allocate 8388608 bytes, 0 MB available
 (seg0 192.168.99.100:25432)

-- start_ignore
! for i in `seq 1 10000`; do echo "host all gpadmin 2001:db8:3333:4444:5555:6666:7777:8888/128 trust" >> ${MASTER_DATA_DIRECTORY}/../../dbfast1/demoDataDir0/pg_hba.conf; done;

! gpstop -rai;
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Starting gpstop with args: -rai
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Gathering information and validating the environment...
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Obtaining Greenplum Coordinator catalog information
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Obtaining Segment details from coordinator...
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.14653.ge4c0aab229b build dev'
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Commencing Coordinator instance shutdown with mode='immediate'
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Coordinator segment instance directory=/home/gpadmin/greenplum-db-data/gpseg-1
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Attempting forceful termination of any leftover coordinator process
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Terminating processes for segment /home/gpadmin/greenplum-db-data/gpseg-1
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-No standby coordinator host configured
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Targeting dbid [2, 5, 3, 6, 4, 7] for shutdown
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-Commencing parallel primary segment instance shutdown, please wait...
20210602:17:20:23:2494274 gpstop:minion:gpadmin-[INFO]:-0.00% of jobs completed
20210602:17:20:24:2494274 gpstop:minion:gpadmin-[INFO]:-100.00% of jobs completed
20210602:17:20:24:2494274 gpstop:minion:gpadmin-[INFO]:-Commencing parallel mirror segment instance shutdown, please wait...
20210602:17:20:24:2494274 gpstop:minion:gpadmin-[INFO]:-0.00% of jobs completed
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-100.00% of jobs completed
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-----------------------------------------------------
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-   Segments stopped successfully      = 6
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-   Segments with errors during stop   = 0
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-----------------------------------------------------
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-Successfully shutdown 6 of 6 segment instances 
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-Database successfully shutdown with no errors reported
20210602:17:20:25:2494274 gpstop:minion:gpadmin-[INFO]:-Restarting System...

-- end_ignore

-- The per segment limit should be reached sooner this time, because the
-- startup memory got bigger.
-- start_ignore
9: set gp_vmem_idle_resource_timeout to '1h';
SET
10: set gp_vmem_idle_resource_timeout to '1h';
SET
11: set gp_vmem_idle_resource_timeout to '1h';
SET
-- end_ignore
12: set gp_vmem_idle_resource_timeout to '1h';
ERROR:  failed to acquire resources on one or more segments
DETAIL:  FATAL:  Out of memory
DETAIL:  VM Protect failed to allocate 18999952 bytes, 0 MB available
 (seg0 127.0.1.1:7002)

-- start_ignore
! head -n -10000 ${MASTER_DATA_DIRECTORY}/../../dbfast1/demoDataDir0/pg_hba.conf > /tmp/pg_hba.txt && mv /tmp/pg_hba.txt ${MASTER_DATA_DIRECTORY}/../../dbfast1/demoDataDir0/pg_hba.conf;

! gpstop -rai;
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Starting gpstop with args: -rai
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Gathering information and validating the environment...
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Obtaining Greenplum Coordinator catalog information
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Obtaining Segment details from coordinator...
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.14653.ge4c0aab229b build dev'
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Commencing Coordinator instance shutdown with mode='immediate'
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Coordinator segment instance directory=/home/gpadmin/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Attempting forceful termination of any leftover coordinator process
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Terminating processes for segment /home/gpadmin/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-No standby coordinator host configured
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Targeting dbid [2, 5, 3, 6, 4, 7] for shutdown
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-Commencing parallel primary segment instance shutdown, please wait...
20210602:18:05:37:2634623 gpstop:minion:gpadmin-[INFO]:-0.00% of jobs completed
20210602:18:05:38:2634623 gpstop:minion:gpadmin-[INFO]:-100.00% of jobs completed
20210602:18:05:38:2634623 gpstop:minion:gpadmin-[INFO]:-Commencing parallel mirror segment instance shutdown, please wait...
20210602:18:05:38:2634623 gpstop:minion:gpadmin-[INFO]:-0.00% of jobs completed
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-100.00% of jobs completed
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-----------------------------------------------------
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-   Segments stopped successfully      = 6
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-   Segments with errors during stop   = 0
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-----------------------------------------------------
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-Successfully shutdown 6 of 6 segment instances 
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-Database successfully shutdown with no errors reported
20210602:18:05:39:2634623 gpstop:minion:gpadmin-[INFO]:-Restarting System...

-- end_ignore
