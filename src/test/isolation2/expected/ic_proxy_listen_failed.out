-- Test case for the scenario which ic-proxy peer listener port has been occupied

-- start_matchsubs
-- m/ic_tcp.c:\d+/
-- s/ic_tcp.c:\d+/ic_tcp.c:LINE/
-- end_matchsubs

1:create table PR_16438 (i int);
CREATE TABLE
1:insert into PR_16438 select generate_series(1,100);
INSERT 0 100
1q: ... <quitting>

-- get one port and occupy it (start_py_httpserver.sh), then restart cluster
-- start_ignore
!\retcode ic_proxy_port=`psql postgres -Atc "show gp_interconnect_proxy_addresses;" | awk -F ',' '{print $1}' | awk -F ':' '{print $4}'` && gpstop -ai && ./script/start_py_httpserver.sh $ic_proxy_port;
-- start_ignore
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Starting gpstop with args: -ai
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Gathering information and validating the environment...
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Obtaining Greenplum Coordinator catalog information
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Obtaining Segment details from coordinator...
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.19326.ge2da67a1d1 build dev'
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Commencing Coordinator instance shutdown with mode='immediate'
20231110:15:29:43:587475 gpstop:gpdb:ubuntu-[INFO]:-Coordinator segment instance directory=/home/ubuntu/gp/data7/master/gpseg-1
20231110:15:29:44:587475 gpstop:gpdb:ubuntu-[INFO]:-Attempting forceful termination of any leftover coordinator process
20231110:15:29:44:587475 gpstop:gpdb:ubuntu-[INFO]:-Terminating processes for segment /home/ubuntu/gp/data7/master/gpseg-1
20231110:15:29:47:587475 gpstop:gpdb:ubuntu-[INFO]:-No standby coordinator host configured
20231110:15:29:47:587475 gpstop:gpdb:ubuntu-[INFO]:-Targeting dbid [2, 5, 3, 6, 4, 7] for shutdown
20231110:15:29:47:587475 gpstop:gpdb:ubuntu-[INFO]:-Commencing parallel primary segment instance shutdown, please wait...
20231110:15:29:47:587475 gpstop:gpdb:ubuntu-[INFO]:-0.00% of jobs completed
20231110:15:29:51:587475 gpstop:gpdb:ubuntu-[INFO]:-100.00% of jobs completed
20231110:15:29:51:587475 gpstop:gpdb:ubuntu-[INFO]:-Commencing parallel mirror segment instance shutdown, please wait...
20231110:15:29:51:587475 gpstop:gpdb:ubuntu-[INFO]:-0.00% of jobs completed
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-100.00% of jobs completed
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-----------------------------------------------------
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-   Segments stopped successfully      = 6
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-----------------------------------------------------
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-Successfully shutdown 6 of 6 segment instances 
20231110:15:29:53:587475 gpstop:gpdb:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
started a http server

-- end_ignore
(exited with code 0)
!\retcode sleep 2 && gpstart -a;
-- start_ignore
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-Starting gpstart with args: -a
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-Gathering information and validating the environment...
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.19326.ge2da67a1d1 build dev'
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-Greenplum Catalog Version: '302307241'
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-Starting Coordinator instance in admin mode
20231110:15:29:55:591614 gpstart:gpdb:ubuntu-[INFO]:-CoordinatorStart pg_ctl cmd is env GPSESSID=0000000000 GPERA=None $GPHOME/bin/pg_ctl -D /home/ubuntu/gp/data7/master/gpseg-1 -l /home/ubuntu/gp/data7/master/gpseg-1/log/startup.log -w -t 600 -o " -c gp_role=utility " start
20231110:15:29:56:591614 gpstart:gpdb:ubuntu-[INFO]:-Obtaining Greenplum Coordinator catalog information
20231110:15:29:56:591614 gpstart:gpdb:ubuntu-[INFO]:-Obtaining Segment details from coordinator...
20231110:15:29:56:591614 gpstart:gpdb:ubuntu-[INFO]:-Setting new coordinator era
20231110:15:29:56:591614 gpstart:gpdb:ubuntu-[INFO]:-Coordinator Started...
20231110:15:29:56:591614 gpstart:gpdb:ubuntu-[INFO]:-Shutting down coordinator
20231110:15:29:59:591614 gpstart:gpdb:ubuntu-[INFO]:-Commencing parallel primary and mirror segment instance startup, please wait...
.
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-Process results...
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-----------------------------------------------------
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-   Successful segment starts                                            = 6
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-----------------------------------------------------
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-Successfully started 6 of 6 segment instances 
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-----------------------------------------------------
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-Starting Coordinator instance gpdb directory /home/ubuntu/gp/data7/master/gpseg-1 
20231110:15:30:00:591614 gpstart:gpdb:ubuntu-[INFO]:-CoordinatorStart pg_ctl cmd is env GPSESSID=0000000000 GPERA=c25b3b36b0fe1320_231110152956 $GPHOME/bin/pg_ctl -D /home/ubuntu/gp/data7/master/gpseg-1 -l /home/ubuntu/gp/data7/master/gpseg-1/log/startup.log -w -t 600 -o " -c gp_role=dispatch " start
20231110:15:30:01:591614 gpstart:gpdb:ubuntu-[INFO]:-Command pg_ctl reports Coordinator gpdb instance active
20231110:15:30:01:591614 gpstart:gpdb:ubuntu-[INFO]:-Connecting to db template1 on host localhost
20231110:15:30:01:591614 gpstart:gpdb:ubuntu-[INFO]:-No standby coordinator configured.  skipping...
20231110:15:30:01:591614 gpstart:gpdb:ubuntu-[INFO]:-Database successfully started

-- end_ignore
(exited with code 0)
-- end_ignore

-- execute a query (should failed)
2&:select count(*) from PR_16438;  <waiting ...>
FAILED:  Forked command is not blocking; got output: ERROR:  Failed to setup ic_proxy interconnect
DETAIL:  The ic_proxy process failed to bind or listen.
HINT:  Please check the server log for related WARNING messages.
2<:  <... completed>
FAILED:  Execution failed

-- kill the script to release port and execute query again (should successfully)
-- start_ignore
!\retcode ps aux | grep http.server | grep -v grep | awk '{print $2}' | xargs kill;
-- start_ignore

-- end_ignore
(exited with code 0)
!\retcode sleep 2;
-- start_ignore

-- end_ignore
(exited with code 0)
-- end_ignore
3:select count(*) from PR_16438;
 count 
-------
 100   
(1 row)
3:drop table PR_16438;
DROP TABLE
