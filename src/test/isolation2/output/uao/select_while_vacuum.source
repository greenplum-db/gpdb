-- @Description Ensures that a select during a vacuum operation is ok
--
DROP TABLE IF EXISTS ao;
DROP
CREATE TABLE ao (a INT) WITH (appendonly=true, orientation=@orientation@);
CREATE
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000
insert into ao select generate_series(1,1000);
INSERT 1000

DELETE FROM ao WHERE a < 128;
DELETE 2667
1: BEGIN;
BEGIN
1>: SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;COMMIT;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;SELECT COUNT(*) FROM ao;COMMIT;  <waiting ...>
2: VACUUM ao;
VACUUM
1<:  <... completed>
SELECT
3: INSERT INTO ao VALUES (0);
INSERT 1


-- Check if SELECT tx stops VACUUM dropping segfiles if they are visible on SELECT
DROP TABLE IF EXISTS ao_vacuum_drop;
DROP
CREATE TABLE ao_vacuum_drop (a int, b int) WITH (appendonly=true, orientation=@orientation@) PARTITION BY range(b) (start (1) end (10) every (5));
CREATE
INSERT INTO ao_vacuum_drop SELECT i, i%9+1 FROM generate_series(1, 2000000)i;
INSERT 2000000
UPDATE ao_vacuum_drop SET a = a + 2 WHERE a % 2 = 1;
UPDATE 1000000
UPDATE ao_vacuum_drop SET a = a + 2 WHERE a % 2 = 0;
UPDATE 1000000

SELECT gp_inject_fault('locks_check_at_select_portal_create', 'suspend', c.dbid) FROM gp_segment_configuration c WHERE role='p' and content=-1;
 gp_inject_fault 
-----------------
 Success:        
(1 row)

1&: SELECT count(*) FROM ao_vacuum_drop;  <waiting ...>
2: SELECT gp_wait_until_triggered_fault('locks_check_at_select_portal_create', 1, dbid) FROM gp_segment_configuration WHERE role='p' AND content = -1;
 gp_wait_until_triggered_fault 
-------------------------------
 Success:                      
(1 row)
2: VACUUM ANALYZE ao_vacuum_drop_1_prt_1;
VACUUM
-- VACUUM shouldn't drop the files and SELECT should complete fine

SELECT gp_inject_fault('locks_check_at_select_portal_create', 'reset', c.dbid) FROM gp_segment_configuration c WHERE role='p' and content=-1;
 gp_inject_fault 
-----------------
 Success:        
(1 row)
1<:  <... completed>
 count   
---------
 2000000 
(1 row)
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 2222224  | 1     
 2     | 1111112  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 740831   | 2     
 2     | 370441   | 1     
(2 rows)

-- Check if insert works fine on inserting data into the correct available files
INSERT INTO ao_vacuum_drop SELECT i, i%9+1 FROM generate_series(1, 200)i;
INSERT 200
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 2222224  | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 740831   | 2     
 2     | 370485   | 1     
(2 rows)

-- VACUUM now should drop the files
VACUUM ANALYZE ao_vacuum_drop_1_prt_1;
VACUUM
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 0        | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 0        | 1     
 2     | 370485   | 1     
 3     | 0        | 1     
(3 rows)

INSERT INTO ao_vacuum_drop SELECT i, i%9+1 FROM generate_series(1, 200)i;
INSERT 200
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 112      | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 44       | 1     
 2     | 370485   | 1     
 3     | 0        | 1     
(3 rows)


-- Check if SELECT tx stops VACUUM FULL dropping segfiles if they are visible on SELECT
DROP TABLE IF EXISTS ao_vacuum_full_drop;
DROP
CREATE TABLE ao_vacuum_full_drop (a int, b int) WITH (appendonly=true, orientation=@orientation@) PARTITION BY range(b) (start (1) end (10) every (5));
CREATE
INSERT INTO ao_vacuum_full_drop SELECT i, i%9+1 FROM generate_series(1, 2000000)i;
INSERT 2000000
UPDATE ao_vacuum_full_drop SET a = a + 2 WHERE a % 2 = 1;
UPDATE 1000000
UPDATE ao_vacuum_full_drop SET a = a + 2 WHERE a % 2 = 0;
UPDATE 1000000

SELECT gp_inject_fault('locks_check_at_select_portal_create', 'suspend', c.dbid) FROM gp_segment_configuration c WHERE role='p' and content=-1;
 gp_inject_fault 
-----------------
 Success:        
(1 row)

1&: SELECT count(*) FROM ao_vacuum_full_drop;  <waiting ...>
2: SELECT gp_wait_until_triggered_fault('locks_check_at_select_portal_create', 1, dbid) FROM gp_segment_configuration WHERE role='p' AND content = -1;
 gp_wait_until_triggered_fault 
-------------------------------
 Success:                      
(1 row)
2: VACUUM FULL ao_vacuum_full_drop_1_prt_1;
VACUUM
-- VACUUM shouldn't drop the files and SELECT should complete fine

SELECT gp_inject_fault('locks_check_at_select_portal_create', 'reset', c.dbid) FROM gp_segment_configuration c WHERE role='p' and content=-1;
 gp_inject_fault 
-----------------
 Success:        
(1 row)
1<:  <... completed>
 count   
---------
 2000000 
(1 row)
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 2222224  | 1     
 2     | 1111112  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 740831   | 2     
 2     | 370441   | 1     
(2 rows)

-- Check if insert works fine on inserting data into the correct available files
INSERT INTO ao_vacuum_full_drop SELECT i, i%9+1 FROM generate_series(1, 200)i;
INSERT 200
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 2222224  | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 740831   | 2     
 2     | 370485   | 1     
(2 rows)

-- VACUUM now should drop the files
VACUUM FULL ao_vacuum_full_drop_1_prt_1;
VACUUM
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 0        | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 0        | 1     
 2     | 370485   | 1     
 3     | 0        | 1     
(3 rows)

-- Check if insert works fine on inserting data into the files
INSERT INTO ao_vacuum_full_drop SELECT i, i%9+1 FROM generate_series(1, 200)i;
INSERT 200
SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 112      | 1     
 2     | 1111224  | 1     
(2 rows)
0U: SELECT segno, tupcount,state FROM gp_ao_or_aocs_seg('ao_vacuum_full_drop_1_prt_1');
 segno | tupcount | state 
-------+----------+-------
 1     | 44       | 1     
 2     | 370485   | 1     
 3     | 0        | 1     
(3 rows)
