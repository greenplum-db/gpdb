CREATE OR REPLACE FUNCTION gp_workfile_mgr_test_on_master(testname text) RETURNS setof bool LANGUAGE C VOLATILE EXECUTE ON MASTER AS '@abs_builddir@/isolation2_regress@DLSUFFIX@', 'gp_workfile_mgr_test_harness';
CREATE

CREATE OR REPLACE FUNCTION gp_workfile_mgr_test_on_segments(testname text) RETURNS setof bool LANGUAGE C VOLATILE EXECUTE ON ALL SEGMENTS AS '@abs_builddir@/isolation2_regress@DLSUFFIX@', 'gp_workfile_mgr_test_harness';
CREATE

CREATE FUNCTION gp_workfile_mgr_test(testname text) RETURNS SETOF BOOL AS $$ SELECT C.* FROM gp_workfile_mgr_test_on_master($1) as C UNION ALL SELECT C.* FROM gp_workfile_mgr_test_on_segments($1) as C $$ LANGUAGE SQL;
CREATE

CREATE OR REPLACE FUNCTION gp_workfile_mgr_create_workset(worksetname text, interXact bool) RETURNS void LANGUAGE C VOLATILE EXECUTE ON ALL SEGMENTS AS '@abs_builddir@/isolation2_regress@DLSUFFIX@', 'gp_workfile_mgr_create_workset';
CREATE

CREATE FUNCTION gp_workfile_mgr_cache_entries() RETURNS TABLE(segid int4, prefix text, size int8, operation text, slice int4, sessionid int4, commandid int4, numfiles int4) AS '$libdir/gp_workfile_mgr', 'gp_workfile_mgr_cache_entries' LANGUAGE C VOLATILE EXECUTE ON ALL SEGMENTS;
CREATE

!\retcode gpconfig -c gp_workfile_max_entries -v 32 --skipvalidation;
-- start_ignore
20200828:10:38:17:115560 gpconfig:09c5497cf854:gpadmin-[INFO]:-completed successfully with parameters '-c gp_workfile_max_entries -v 32 --skipvalidation'

-- end_ignore
(exited with code 0)
!\retcode gpstop -ari;
-- start_ignore
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Starting gpstop with args: -ari
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Gathering information and validating the environment...
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Obtaining Greenplum Master catalog information
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Obtaining Segment details from master...
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.7252.gd18d81bbe3a build dev'
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing Master instance shutdown with mode='immediate'
20200828:10:38:17:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Master segment instance directory=/home/gpadmin/workspace/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Attempting forceful termination of any leftover master process
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Terminating processes for segment /home/gpadmin/workspace/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Stopping master standby host 09c5497cf854 mode=immediate
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Successfully shutdown standby process on 09c5497cf854
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Targeting dbid [2, 5, 3, 6, 4, 7] for shutdown
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing parallel primary segment instance shutdown, please wait...
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-0.00% of jobs completed
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-100.00% of jobs completed
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing parallel mirror segment instance shutdown, please wait...
20200828:10:38:18:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-0.00% of jobs completed
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-100.00% of jobs completed
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-----------------------------------------------------
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-   Segments stopped successfully      = 6
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-   Segments with errors during stop   = 0
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-----------------------------------------------------
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Successfully shutdown 6 of 6 segment instances 
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Database successfully shutdown with no errors reported
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Cleaning up leftover shared memory
20200828:10:38:19:115635 gpstop:09c5497cf854:gpadmin-[INFO]:-Restarting System...

-- end_ignore
(exited with code 0)

-- setup for workfile made in temp tablespace test
! mkdir -p '@testtablespace@/workfile_mgr';

1: DROP TABLESPACE IF EXISTS work_file_test_ts;
DROP
1: CREATE TABLESPACE work_file_test_ts LOCATION '@testtablespace@/workfile_mgr';
CREATE

1: select gp_workfile_mgr_test('execworkfile_buffile_test');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('atomic_test');
 gp_workfile_mgr_test 
----------------------
 f                    
 f                    
 f                    
 f                    
(4 rows)
1: select gp_workfile_mgr_test('fd_tests');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('buffile_size_test');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('buffile_large_file_test');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('logicaltape_test');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('fd_large_file_test');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('execworkfile_create_one_MB_file');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)

-- test will fail when the workset exceeds gp_workfile_max_entries, the workset will be released at the end of transaction.
1: select gp_workfile_mgr_test('workfile_fill_sharedcache');
ERROR:  could not create workfile manager entry: exceeded number of concurrent spilling queries
CONTEXT:  SQL function "gp_workfile_mgr_test" statement 1
1: select segid, count(*) from gp_workfile_mgr_cache_entries() group by segid order by segid;
 segid | count 
-------+-------
(0 rows)

1: select gp_workfile_mgr_test('workfile_create_and_set_cleanup');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('workfile_create_and_individual_cleanup');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)
1: select gp_workfile_mgr_test('workfile_made_in_temp_tablespace');
 gp_workfile_mgr_test 
----------------------
 t                    
 t                    
 t                    
 t                    
(4 rows)

1: DROP TABLESPACE work_file_test_ts;
DROP
!\retcode gpconfig -r gp_workfile_max_entries --skipvalidation;
-- start_ignore
20200828:10:40:17:116211 gpconfig:09c5497cf854:gpadmin-[INFO]:-completed successfully with parameters '-r gp_workfile_max_entries --skipvalidation'

-- end_ignore
(exited with code 0)
!\retcode gpstop -ari;
-- start_ignore
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Starting gpstop with args: -ari
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Gathering information and validating the environment...
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Obtaining Greenplum Master catalog information
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Obtaining Segment details from master...
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 7.0.0-alpha.0+dev.7252.gd18d81bbe3a build dev'
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing Master instance shutdown with mode='immediate'
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Master segment instance directory=/home/gpadmin/workspace/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Attempting forceful termination of any leftover master process
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Terminating processes for segment /home/gpadmin/workspace/gpdb/gpAux/gpdemo/datadirs/qddir/demoDataDir-1
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Stopping master standby host 09c5497cf854 mode=immediate
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Successfully shutdown standby process on 09c5497cf854
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Targeting dbid [2, 5, 3, 6, 4, 7] for shutdown
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing parallel primary segment instance shutdown, please wait...
20200828:10:40:17:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-0.00% of jobs completed
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-100.00% of jobs completed
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Commencing parallel mirror segment instance shutdown, please wait...
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-0.00% of jobs completed
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-100.00% of jobs completed
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-----------------------------------------------------
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-   Segments stopped successfully      = 6
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-   Segments with errors during stop   = 0
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-----------------------------------------------------
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Successfully shutdown 6 of 6 segment instances 
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Database successfully shutdown with no errors reported
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Cleaning up leftover shared memory
20200828:10:40:18:116286 gpstop:09c5497cf854:gpadmin-[INFO]:-Restarting System...

-- end_ignore
(exited with code 0)

-- test workset cleanup
2: begin;
BEGIN
2: select gp_workfile_mgr_create_workset('long_live_workset', false);
 gp_workfile_mgr_create_workset 
--------------------------------
                                
                                
                                
(3 rows)

3: select gp_workfile_mgr_create_workset('inter_xact_workset', true);
 gp_workfile_mgr_create_workset 
--------------------------------
                                
                                
                                
(3 rows)

-- transaction commit will cleanup the workset.
4: begin;
BEGIN
4: select gp_workfile_mgr_create_workset('commit_tnx_workset', false);
 gp_workfile_mgr_create_workset 
--------------------------------
                                
                                
                                
(3 rows)
4: select segid, prefix, size, operation, slice, numfiles from gp_workfile_mgr_cache_entries() order by (segid, prefix);
 segid | prefix               | size | operation          | slice | numfiles 
-------+----------------------+------+--------------------+-------+----------
 0     | commit_tnx_workset_3 | 0    | commit_tnx_workset | 1     | 0        
 0     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 0     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 1     | commit_tnx_workset_3 | 0    | commit_tnx_workset | 1     | 0        
 1     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 1     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 2     | commit_tnx_workset_3 | 0    | commit_tnx_workset | 1     | 0        
 2     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 2     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
(9 rows)
4: end;
END
4: select segid, prefix, size, operation, slice, numfiles from gp_workfile_mgr_cache_entries() order by (segid, prefix);
 segid | prefix               | size | operation          | slice | numfiles 
-------+----------------------+------+--------------------+-------+----------
 0     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 0     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 1     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 1     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 2     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 2     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
(6 rows)

-- transaction commit will cleanup the workset.
4: begin;
BEGIN
4: select gp_workfile_mgr_create_workset('abort_tnx_workset', false);
 gp_workfile_mgr_create_workset 
--------------------------------
                                
                                
                                
(3 rows)
4: select segid, prefix, size, operation, slice, numfiles from gp_workfile_mgr_cache_entries() order by (segid, prefix);
 segid | prefix               | size | operation          | slice | numfiles 
-------+----------------------+------+--------------------+-------+----------
 0     | abort_tnx_workset_3  | 0    | abort_tnx_workset  | 1     | 0        
 0     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 0     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 1     | abort_tnx_workset_3  | 0    | abort_tnx_workset  | 1     | 0        
 1     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 1     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 2     | abort_tnx_workset_3  | 0    | abort_tnx_workset  | 1     | 0        
 2     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 2     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
(9 rows)
4: abort;
ABORT
4: select segid, prefix, size, operation, slice, numfiles from gp_workfile_mgr_cache_entries() order by (segid, prefix);
 segid | prefix               | size | operation          | slice | numfiles 
-------+----------------------+------+--------------------+-------+----------
 0     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 0     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 1     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 1     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
 2     | inter_xact_workset_2 | 0    | inter_xact_workset | 1     | 0        
 2     | long_live_workset_1  | 0    | long_live_workset  | 1     | 0        
(6 rows)

-- for workset lives across transaction, e.g. with hold cursor, proc exit will cleanup the workset
3q: ... <quitting>
4: select segid, prefix, size, operation, slice, numfiles from gp_workfile_mgr_cache_entries() order by (segid, prefix);
 segid | prefix              | size | operation         | slice | numfiles 
-------+---------------------+------+-------------------+-------+----------
 0     | long_live_workset_1 | 0    | long_live_workset | 1     | 0        
 1     | long_live_workset_1 | 0    | long_live_workset | 1     | 0        
 2     | long_live_workset_1 | 0    | long_live_workset | 1     | 0        
(3 rows)
