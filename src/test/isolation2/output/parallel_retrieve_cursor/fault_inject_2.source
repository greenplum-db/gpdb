-- @Description Tests with faut inject
--
DROP TABLE IF EXISTS t2;
DROP
CREATE TABLE t2 (a INT) DISTRIBUTED by (a);
CREATE
insert into t2 select generate_series(1,10000000);
INSERT 10000000

CREATE EXTENSION IF NOT EXISTS gp_inject_fault;
CREATE

-- Test1: error inject at the 1000th time while retrieving tuples from endpoint. other retrieve session finished.
-- This test may cause GPDB hang/crash on MacOS because the UDP thread receive signal which shouldn't.
-- (OS-X pthread_sigmask is broken: MPP-4923).
1: SELECT gp_inject_fault('fetch_tuples_from_endpoint', 'reset', 3);
 gp_inject_fault 
-----------------
 Success:        
(1 row)
1: SELECT gp_inject_fault('fetch_tuples_from_endpoint', 'interrupt', '', '', '', 1000, 1000, 0, 3::smallint);
 gp_inject_fault 
-----------------
 Success:        
(1 row)

1: BEGIN;
BEGIN
1: DECLARE c1 PARALLEL RETRIEVE CURSOR FOR SELECT * from t2;
DECLARE
1: @post_run 'parse_endpoint_info 6 1 2 3 4' : SELECT endpointname,auth_token,hostname,port,state FROM gp_endpoints() WHERE cursorname='c1';
 endpoint_id6_1 | token_id | host_id | port_id | READY
 endpoint_id6_2 | token_id | host_id | port_id | READY
 endpoint_id6_3 | token_id | host_id | port_id | READY
(3 rows)
1&: SELECT * FROM gp_wait_parallel_retrieve_cursor('c1');  <waiting ...>

0U: SELECT state FROM gp_segment_endpoints() WHERE cursorname='c1';
 state 
-------
 READY 
(1 row)
0R&: @pre_run 'set_endpoint_variable @ENDPOINT6': RETRIEVE ALL FROM ENDPOINT "@ENDPOINT6";  <waiting ...>

2U: SELECT state FROM gp_segment_endpoints() WHERE cursorname='c1';
 state 
-------
 READY 
(1 row)
2R&: @pre_run 'set_endpoint_variable @ENDPOINT6': RETRIEVE ALL FROM ENDPOINT "@ENDPOINT6";  <waiting ...>

1U: SELECT state FROM gp_segment_endpoints() WHERE cursorname='c1';
 state 
-------
 READY 
(1 row)
1R: @pre_run 'set_endpoint_variable @ENDPOINT6': RETRIEVE ALL FROM ENDPOINT "@ENDPOINT6";
ERROR:  canceling statement due to user request

1<:  <... completed>
ERROR:  canceling MPP operation: "Endpoint retrieve statement aborted"

0R<:  <... completed>
ERROR:  Parallel RETRIEVE CURSOR endpoint endpoint_id6_1 aborted unexpectedly.
2R<:  <... completed>
ERROR:  Parallel RETRIEVE CURSOR endpoint endpoint_id6_3 aborted unexpectedly.

1<:  <... completed>
 FAILED:  Execution failed
1: ROLLBACK;
ROLLBACK
1: SELECT gp_inject_fault('fetch_tuples_from_endpoint', 'reset', 3);
 gp_inject_fault 
-----------------
 Success:        
(1 row)

