-- @Description Tests the basic behavior of (lazy) vacuum w.r.t. to the threshold guc.
-- The output depends on the number of segments as the skip decision and the 
-- notify is done on the segments.
CREATE TABLE uaocs_threshold (a INT, b INT, c CHAR(128)) WITH (appendonly=true, orientation=column);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE INDEX uaocs_threshold_index ON uaocs_threshold(b);
INSERT INTO uaocs_threshold SELECT i as a, 1 as b, 'hello world' as c FROM generate_series(1, 100) AS i;
\set QUIET off
VACUUM uaocs_threshold;
VACUUM
DELETE FROM uaocs_threshold WHERE a < 4;
DELETE 3
SELECT COUNT(*) FROM uaocs_threshold;
 count 
-------
    97
(1 row)

SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |      100 |     1
(1 row)

-- 97 visible tuples, no vacuum
VACUUM uaocs_threshold;
VACUUM
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |      100 |     1
(1 row)

DELETE FROM uaocs_threshold WHERE a < 12;
DELETE 8
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |      100 |     1
(1 row)

-- 89 visible tuples, do vacuum
VACUUM uaocs_threshold;
VACUUM
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |       50 |     1
     2 |       44 |     1
(2 rows)

-- no invisible tuples, no vacuum
VACUUM uaocs_threshold;
VACUUM
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |       50 |     1
     2 |       44 |     1
(2 rows)

DELETE FROM uaocs_threshold WHERE a < 15;
DELETE 3
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     1 |       50 |     1
     2 |       44 |     1
(2 rows)

-- 3 invisible tuples, no vacuum
VACUUM uaocs_threshold;
VACUUM
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     2 |       44 |     1
     1 |        0 |     1
     3 |       43 |     1
(3 rows)

SET gp_appendonly_compaction_threshold=2;
SET
-- 3 invisible tuples, no vacuum
VACUUM uaocs_threshold;
VACUUM
SELECT DISTINCT segno, tupcount, state FROM gp_toolkit.__gp_aocsseg_name('uaocs_threshold');
 segno | tupcount | state 
-------+----------+-------
     2 |       44 |     1
     1 |        0 |     1
     3 |       43 |     1
(3 rows)

