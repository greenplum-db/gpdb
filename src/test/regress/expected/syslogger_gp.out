-- Smoke tests for syslogger (since GP syslogger code is dvergent from upstream)
create or replace function get_log_master(log_message text)
returns table (log_time timestamp WITH TIME ZONE,
               log_session text,
               log_msg text) as
$$
declare
  session_id text;
  curtime timestamp;
begin
  select now()::timestamp at TIME ZONE 'CST' as "Timestamp CST" into curtime;
  select current_setting('gp_session_id') into session_id;
  session_id = 'con' || session_id;
  raise log '%', log_message;
  return query select logtime, logsession, logmessage from gp_toolkit.gp_log_master_concise where logmessage = log_message and logtime > curtime and logsession = session_id;
end;
$$ language plpgsql;
select get_log_master('message with a " mark');
                             get_log_master                             
------------------------------------------------------------------------
 ("Mon Jun 27 16:56:35.854891 2022 PDT",con68,"message with a "" mark")
(1 row)

select get_log_master('message with two "" mark');
                               get_log_master                               
----------------------------------------------------------------------------
 ("Mon Jun 27 16:56:35.904158 2022 PDT",con68,"message with two """" mark")
(1 row)

select get_log_master('message with three """ mark');
                                 get_log_master                                 
--------------------------------------------------------------------------------
 ("Mon Jun 27 16:56:35.951774 2022 PDT",con68,"message with three """""" mark")
(1 row)

select get_log_master('message with foo"');
                           get_log_master                           
--------------------------------------------------------------------
 ("Mon Jun 27 16:56:36.000989 2022 PDT",con68,"message with foo""")
(1 row)

select get_log_master('message with ""foo""bar"');
                                get_log_master                                 
-------------------------------------------------------------------------------
 ("Mon Jun 27 16:56:36.048284 2022 PDT",con68,"message with """"foo""""bar""")
(1 row)

select get_log_master('message with no quotes');
                             get_log_master                             
------------------------------------------------------------------------
 ("Mon Jun 27 16:56:36.095955 2022 PDT",con68,"message with no quotes")
(1 row)

