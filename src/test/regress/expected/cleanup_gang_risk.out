--
-- Tests for return correct error from qe when create extension error
-- The issue: https://github.com/greenplum-db/gpdb/issues/11304
--
--start_ignore
drop extension if exists gp_debug_numsegments;
NOTICE:  extension "gp_debug_numsegments" does not exist, skipping
create extension if not exists gp_inject_fault;
--end_ignore
select gp_inject_fault('create_function_fail', 'error', dbid) from gp_segment_configuration where role = 'p' and content = 1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

create extension gp_debug_numsegments;
ERROR:  fault triggered, fault name:'create_function_fail' fault type:'error'  (seg1 127.0.1.1:7003 pid=209289)
create table t_11304(a int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
select gp_inject_fault('create_function_fail', 'reset', dbid) from gp_segment_configuration where role = 'p' and content = 1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

\c
drop table t_11304;
-- Test for Github Issue https://github.com/greenplum-db/gpdb/issues/12703
create table t_12703(a int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
insert into t_12703 values (1);
begin;
declare myc CURSOR for select * from t_12703;
select gp_inject_fault('destroy_gang_namedportal_risk_creategang', 'skip', dbid) from gp_segment_configuration where role = 'p' and content = -1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

savepoint xxx;
ERROR:  gang was lost due to cluster reconfiguration (cdbgang_async.c:103)
abort;
select gp_inject_fault('destroy_gang_namedportal_risk_creategang', 'reset', dbid) from gp_segment_configuration where role = 'p' and content = -1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

begin;
declare myc CURSOR for select * from t_12703;
select gp_inject_fault('destroy_gang_namedportal_risk_copy', 'skip', dbid) from gp_segment_configuration where role = 'p' and content = -1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

copy t_12703 from stdin;
ERROR:  MPP detected 1 segment failures, system is reconnected
abort;
select gp_inject_fault('destroy_gang_namedportal_risk_copy', 'reset', dbid) from gp_segment_configuration where role = 'p' and content = -1;
 gp_inject_fault 
-----------------
 Success:
(1 row)

