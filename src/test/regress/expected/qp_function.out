-- ----------------------------------------------------------------------
-- Test: setup.sql
-- ----------------------------------------------------------------------
RESET ALL;
-- start_ignore
create schema qp_idf;
set search_path to qp_idf;
create language plpythonu;
create table perct as select a, a / 10 as b from generate_series(1, 100)a;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perct2 as select a, a / 10 as b from generate_series(1, 100)a, generate_series(1, 2);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perct3 as select a, b from perct, generate_series(1, 10)i where a % 7 < i;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perct4 as select case when a % 10 = 5 then null else a end as a,
        b, null::float as c from perct;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table percts as select '2012-01-01 00:00:00'::timestamp + interval '1day' * i as a,
        i / 10 as b, i as c from generate_series(1, 100)i;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perctsz as select '2012-01-01 00:00:00 UTC'::timestamptz + interval '1day' * i as a,
        i / 10 as b, i as c from generate_series(1, 100)i;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perctnum as select a, (a / 13)::float8  as b, (a * 1.9999 )::numeric as c  from generate_series(1, 100)a;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create table perctint as select 
'2006-01-01 13:10:13'::timestamp + interval '1day' * i as ts1,
'2010-01-01 23:10:03'::timestamp + interval '1day 20 hours 12 minutes' * i as ts2,
 '2006-01-01 13:10:13'::timestamptz + interval '10 minutes' * i as tstz1,
'2006-01-01 13:10:13'::timestamptz + interval '12 hours 10 minutes' * i as tstz2, 
interval '1 day 1 hour 12 secs' * i as days1,interval '42 minutes 10 seconds' * i as days2,
random() * 9 + i  as b, 
i as c from generate_series(1, 100)i;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'ts1' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET datestyle = "ISO, DMY";
-- end_ignore
--TIMESTAMPTZ
select c, percentile_cont(0.9999) within group (order by tstz2 - tstz1) from perctint group by c  order by c limit 10;
 c  |  percentile_cont  
----+-------------------
  1 | @ 12 hours
  2 | @ 1 day
  3 | @ 1 day 12 hours
  4 | @ 2 days
  5 | @ 2 days 12 hours
  6 | @ 3 days
  7 | @ 3 days 12 hours
  8 | @ 4 days
  9 | @ 4 days 12 hours
 10 | @ 5 days
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 + days1 ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-03 02:20:25-08
  2 | 2006-01-04 15:30:37-08
  3 | 2006-01-06 04:40:49-08
  4 | 2006-01-07 17:51:01-08
  5 | 2006-01-09 07:01:13-08
  6 | 2006-01-10 20:11:25-08
  7 | 2006-01-12 09:21:37-08
  8 | 2006-01-13 22:31:49-08
  9 | 2006-01-15 11:42:01-08
 10 | 2006-01-17 00:52:13-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 - days1 ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-01 00:20:01-08
  2 | 2005-12-31 11:29:49-08
  3 | 2005-12-30 22:39:37-08
  4 | 2005-12-30 09:49:25-08
  5 | 2005-12-29 20:59:13-08
  6 | 2005-12-29 08:09:01-08
  7 | 2005-12-28 19:18:49-08
  8 | 2005-12-28 06:28:37-08
  9 | 2005-12-27 17:38:25-08
 10 | 2005-12-27 04:48:13-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 + interval '2 hours 3 minutes 10 secs' ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-02 03:23:23-08
  2 | 2006-01-02 15:33:23-08
  3 | 2006-01-03 03:43:23-08
  4 | 2006-01-03 15:53:23-08
  5 | 2006-01-04 04:03:23-08
  6 | 2006-01-04 16:13:23-08
  7 | 2006-01-05 04:23:23-08
  8 | 2006-01-05 16:33:23-08
  9 | 2006-01-06 04:43:23-08
 10 | 2006-01-06 16:53:23-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 - interval '1 hour' ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-02 00:20:13-08
  2 | 2006-01-02 12:30:13-08
  3 | 2006-01-03 00:40:13-08
  4 | 2006-01-03 12:50:13-08
  5 | 2006-01-04 01:00:13-08
  6 | 2006-01-04 13:10:13-08
  7 | 2006-01-05 01:20:13-08
  8 | 2006-01-05 13:30:13-08
  9 | 2006-01-06 01:40:13-08
 10 | 2006-01-06 13:50:13-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 + time '03:00' ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-02 04:20:13-08
  2 | 2006-01-02 16:30:13-08
  3 | 2006-01-03 04:40:13-08
  4 | 2006-01-03 16:50:13-08
  5 | 2006-01-04 05:00:13-08
  6 | 2006-01-04 17:10:13-08
  7 | 2006-01-05 05:20:13-08
  8 | 2006-01-05 17:30:13-08
  9 | 2006-01-06 05:40:13-08
 10 | 2006-01-06 17:50:13-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by tstz2 - time '10:11:26' ) from perctint group by c  order by c limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2006-01-01 15:08:47-08
  2 | 2006-01-02 03:18:47-08
  3 | 2006-01-02 15:28:47-08
  4 | 2006-01-03 03:38:47-08
  5 | 2006-01-03 15:48:47-08
  6 | 2006-01-04 03:58:47-08
  7 | 2006-01-04 16:08:47-08
  8 | 2006-01-05 04:18:47-08
  9 | 2006-01-05 16:28:47-08
 10 | 2006-01-06 04:38:47-08
(10 rows)

select c , median( tstz2 - tstz1 ) from perctint group by c order by c limit 10 ;
 c  |      median       
----+-------------------
  1 | @ 12 hours
  2 | @ 1 day
  3 | @ 1 day 12 hours
  4 | @ 2 days
  5 | @ 2 days 12 hours
  6 | @ 3 days
  7 | @ 3 days 12 hours
  8 | @ 4 days
  9 | @ 4 days 12 hours
 10 | @ 5 days
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::timestamptz -ts1:: timestamptz) from perctint group by c order by 2 limit 10;
 c  |           percentile_cont            
----+--------------------------------------
  1 | @ 1462 days 6 hours 11 mins 50 secs
  2 | @ 1463 days 2 hours 23 mins 50 secs
  3 | @ 1463 days 22 hours 35 mins 50 secs
  4 | @ 1464 days 18 hours 47 mins 50 secs
  5 | @ 1465 days 14 hours 59 mins 50 secs
  6 | @ 1466 days 11 hours 11 mins 50 secs
  7 | @ 1467 days 7 hours 23 mins 50 secs
  8 | @ 1468 days 3 hours 35 mins 50 secs
  9 | @ 1468 days 23 hours 47 mins 50 secs
 10 | @ 1469 days 19 hours 59 mins 50 secs
(10 rows)

-- DATE
select c, percentile_cont(0.9999) within group (order by ts2::date -ts1::date) from perctint group by c order by 2 limit 10;
 c  | percentile_cont 
----+-----------------
  1 |            1462
  2 |            1463
  3 |            1464
  4 |            1465
  5 |            1466
  7 |            1467
  6 |            1467
  8 |            1468
  9 |            1469
 10 |            1470
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::date + integer '10' ) from perctint group by c order by 2 limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2010-01-13 00:00:00-08
  2 | 2010-01-15 00:00:00-08
  3 | 2010-01-17 00:00:00-08
  4 | 2010-01-19 00:00:00-08
  5 | 2010-01-21 00:00:00-08
  6 | 2010-01-23 00:00:00-08
  7 | 2010-01-24 00:00:00-08
  8 | 2010-01-26 00:00:00-08
  9 | 2010-01-28 00:00:00-08
 10 | 2010-01-30 00:00:00-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::date - integer '07' ) from perctint group by c order by 2 limit 10;
 c  |    percentile_cont     
----+------------------------
  1 | 2009-12-27 00:00:00-08
  2 | 2009-12-29 00:00:00-08
  3 | 2009-12-31 00:00:00-08
  4 | 2010-01-02 00:00:00-08
  5 | 2010-01-04 00:00:00-08
  6 | 2010-01-06 00:00:00-08
  7 | 2010-01-07 00:00:00-08
  8 | 2010-01-09 00:00:00-08
  9 | 2010-01-11 00:00:00-08
 10 | 2010-01-13 00:00:00-08
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::date + days2 ) from perctint group by c order by 2 limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-03 00:42:10
  2 | 2010-01-05 01:24:20
  3 | 2010-01-07 02:06:30
  4 | 2010-01-09 02:48:40
  5 | 2010-01-11 03:30:50
  6 | 2010-01-13 04:13:00
  7 | 2010-01-14 04:55:10
  8 | 2010-01-16 05:37:20
  9 | 2010-01-18 06:19:30
 10 | 2010-01-20 07:01:40
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::date - days1 ) from perctint group by c order by 2 limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-01 22:59:48
  2 | 2010-01-02 21:59:36
  3 | 2010-01-03 20:59:24
  4 | 2010-01-04 19:59:12
  5 | 2010-01-05 18:59:00
  7 | 2010-01-06 16:58:36
  6 | 2010-01-06 17:58:48
  8 | 2010-01-07 15:58:24
  9 | 2010-01-08 14:58:12
 10 | 2010-01-09 13:58:00
(10 rows)

select median(ts2::date + interval '2 hours 10 minutes' ), percentile_cont(0.9999) within group (order by ts2::date + time '03:00' )    from perctint;
       median        |    percentile_cont     
---------------------+------------------------
 2010-04-04 14:10:00 | 2010-07-05 02:31:29.28
(1 row)

select c, percentile_cont(0.9999) within group (order by ts2::date - time '10:11:26' ) from perctint group by c order by 2 limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-02 13:48:34
  2 | 2010-01-04 13:48:34
  3 | 2010-01-06 13:48:34
  4 | 2010-01-08 13:48:34
  5 | 2010-01-10 13:48:34
  6 | 2010-01-12 13:48:34
  7 | 2010-01-13 13:48:34
  8 | 2010-01-15 13:48:34
  9 | 2010-01-17 13:48:34
 10 | 2010-01-19 13:48:34
(10 rows)

select c,median(ts2::date -ts1::date) from perctint group by c order by c limit 10;
 c  | median 
----+--------
  1 |   1462
  2 |   1463
  3 |   1464
  4 |   1465
  5 |   1466
  6 |   1467
  7 |   1467
  8 |   1468
  9 |   1469
 10 |   1470
(10 rows)

-- TIMESTAMP
select c, percentile_cont(0.9999) within group (order by ts2::timestamp - ts1::timestamp) from perctint group by c  order by c limit 10;
 c  |           percentile_cont            
----+--------------------------------------
  1 | @ 1462 days 6 hours 11 mins 50 secs
  2 | @ 1463 days 2 hours 23 mins 50 secs
  3 | @ 1463 days 22 hours 35 mins 50 secs
  4 | @ 1464 days 18 hours 47 mins 50 secs
  5 | @ 1465 days 14 hours 59 mins 50 secs
  6 | @ 1466 days 11 hours 11 mins 50 secs
  7 | @ 1467 days 7 hours 23 mins 50 secs
  8 | @ 1468 days 3 hours 35 mins 50 secs
  9 | @ 1468 days 23 hours 47 mins 50 secs
 10 | @ 1469 days 19 hours 59 mins 50 secs
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::timestamp + days1 ) from perctint group by c  order by c limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-04 20:22:15
  2 | 2010-01-07 17:34:27
  3 | 2010-01-10 14:46:39
  4 | 2010-01-13 11:58:51
  5 | 2010-01-16 09:11:03
  6 | 2010-01-19 06:23:15
  7 | 2010-01-22 03:35:27
  8 | 2010-01-25 00:47:39
  9 | 2010-01-27 21:59:51
 10 | 2010-01-30 19:12:03
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::timestamp - days1 ) from perctint group by c  order by c limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-02 18:21:51
  2 | 2010-01-03 13:33:39
  3 | 2010-01-04 08:45:27
  4 | 2010-01-05 03:57:15
  5 | 2010-01-05 23:09:03
  6 | 2010-01-06 18:20:51
  7 | 2010-01-07 13:32:39
  8 | 2010-01-08 08:44:27
  9 | 2010-01-09 03:56:15
 10 | 2010-01-09 23:08:03
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::timestamp + interval '2 hours 3 minutes 10 secs' ) from perctint group by c  order by c limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-03 21:25:13
  2 | 2010-01-05 17:37:13
  3 | 2010-01-07 13:49:13
  4 | 2010-01-09 10:01:13
  5 | 2010-01-11 06:13:13
  6 | 2010-01-13 02:25:13
  7 | 2010-01-14 22:37:13
  8 | 2010-01-16 18:49:13
  9 | 2010-01-18 15:01:13
 10 | 2010-01-20 11:13:13
(10 rows)

select c, percentile_cont(0.9999) within group (order by ts2::timestamp - interval '1 hour' ) from perctint group by c  order by c limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-03 18:22:03
  2 | 2010-01-05 14:34:03
  3 | 2010-01-07 10:46:03
  4 | 2010-01-09 06:58:03
  5 | 2010-01-11 03:10:03
  6 | 2010-01-12 23:22:03
  7 | 2010-01-14 19:34:03
  8 | 2010-01-16 15:46:03
  9 | 2010-01-18 11:58:03
 10 | 2010-01-20 08:10:03
(10 rows)

select median(ts2::timestamp + time '   12:00'), percentile_cont(0.9999) within group (order by ts2::timestamp + time '03:00' ) from perctint ;
       median        |     percentile_cont     
---------------------+-------------------------
 2010-04-05 11:16:03 | 2010-07-05 05:43:47.712
(1 row)

select c, percentile_cont(0.9999) within group (order by ts2::timestamp - time '10:11:26' ) from perctint group by c  order by c limit 10;
 c  |   percentile_cont   
----+---------------------
  1 | 2010-01-03 09:10:37
  2 | 2010-01-05 05:22:37
  3 | 2010-01-07 01:34:37
  4 | 2010-01-08 21:46:37
  5 | 2010-01-10 17:58:37
  6 | 2010-01-12 14:10:37
  7 | 2010-01-14 10:22:37
  8 | 2010-01-16 06:34:37
  9 | 2010-01-18 02:46:37
 10 | 2010-01-19 22:58:37
(10 rows)

-- TIME
select median(  time '01:00' + interval '3 hours') ;
  median   
-----------
 @ 4 hours
(1 row)

select percentile_cont(0.77) within group ( order by time '01:00' + interval '3 hours') ;
 percentile_cont 
-----------------
 @ 4 hours
(1 row)

select c, percentile_cont(0.9999) within group (order by time '11:11' + days2 ) from perctint group by c order by c limit 10;
 c  |      percentile_cont       
----+----------------------------
  1 | @ 11 hours 53 mins 10 secs
  2 | @ 12 hours 35 mins 20 secs
  3 | @ 13 hours 17 mins 30 secs
  4 | @ 13 hours 59 mins 40 secs
  5 | @ 14 hours 41 mins 50 secs
  6 | @ 15 hours 24 mins
  7 | @ 16 hours 6 mins 10 secs
  8 | @ 16 hours 48 mins 20 secs
  9 | @ 17 hours 30 mins 30 secs
 10 | @ 18 hours 12 mins 40 secs
(10 rows)

-- interval
select median(- interval '23 hours');
     median     
----------------
 @ 23 hours ago
(1 row)

select median(interval '1 hour' / double precision '1.5');
  median   
-----------
 @ 40 mins
(1 row)

select c, percentile_cont(0.9999) within group (order by days1 -days2 ) from perctint group by c order by c limit 10;
 c  |         percentile_cont          
----+----------------------------------
  1 | @ 1 day 18 mins 2 secs
  2 | @ 2 days 36 mins 4 secs
  3 | @ 3 days 54 mins 6 secs
  4 | @ 4 days 1 hour 12 mins 8 secs
  5 | @ 5 days 1 hour 30 mins 10 secs
  6 | @ 6 days 1 hour 48 mins 12 secs
  7 | @ 7 days 2 hours 6 mins 14 secs
  8 | @ 8 days 2 hours 24 mins 16 secs
  9 | @ 9 days 2 hours 42 mins 18 secs
 10 | @ 10 days 3 hours 20 secs
(10 rows)

select c, percentile_cont(0.9999) within group (order by ((days1 -days2) / double precision '1.75')) from perctint group by c order by c limit 10;
 c  |             percentile_cont              
----+------------------------------------------
  1 | @ 13 hours 53 mins 9.714285 secs
  2 | @ 1 day 3 hours 46 mins 19.428572 secs
  3 | @ 1 day 17 hours 39 mins 29.142857 secs
  4 | @ 2 days 7 hours 32 mins 38.857143 secs
  5 | @ 2 days 21 hours 25 mins 48.571428 secs
  6 | @ 3 days 11 hours 18 mins 58.285715 secs
  7 | @ 4 days 1 hour 12 mins 8 secs
  8 | @ 4 days 15 hours 5 mins 17.714285 secs
  9 | @ 5 days 4 hours 58 mins 27.428572 secs
 10 | @ 5 days 18 hours 51 mins 37.142857 secs
(10 rows)

select c, percentile_cont(0.9999) within group (order by ((days1 + days2) * 1.2) ) from perctint group by c order by c limit 10;
 c  |           percentile_cont            
----+--------------------------------------
  1 | @ 1 day 6 hours 50 mins 50.4 secs
  2 | @ 2 days 13 hours 41 mins 40.8 secs
  3 | @ 3 days 20 hours 32 mins 31.2 secs
  4 | @ 4 days 27 hours 23 mins 21.6 secs
  5 | @ 6 days 10 hours 14 mins 12 secs
  6 | @ 7 days 17 hours 5 mins 2.4 secs
  7 | @ 8 days 23 hours 55 mins 52.8 secs
  8 | @ 9 days 30 hours 46 mins 43.2 secs
  9 | @ 10 days 37 hours 37 mins 33.6 secs
 10 | @ 12 days 20 hours 28 mins 24 secs
(10 rows)

--numeric types
select b, percentile_cont(0.9876) within group( order by c::numeric - 2.8765::numeric) from perctnum group by b order by b limit 10;
 b | percentile_cont 
---+-----------------
 0 |     20.84951364
 1 |     46.82341488
 2 |     72.82211488
 3 |     98.82081488
 4 |    124.81951488
 5 |    150.81821488
 6 |    176.81691488
 7 |    196.89031116
(8 rows)

select median( c::numeric + (0.2*0.99):: numeric) from perctnum;
  median   
-----------
 101.19295
(1 row)

select percentile_cont(1.00) within group( order by b::float8 + (110 / 13)::float8) from perctnum; 
 percentile_cont 
-----------------
              15
(1 row)

