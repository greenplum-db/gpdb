-- This file is used to test the feature that there are multiple remote postgres servers.
-- ===================================================================
-- create FDW objects
-- ===================================================================
SET timezone = 'PST8PDT';
-- Clean
-- start_ignore
DROP EXTENSION IF EXISTS postgres_fdw CASCADE;
-- end_ignore
CREATE EXTENSION postgres_fdw;
CREATE SERVER pgserver FOREIGN DATA WRAPPER postgres_fdw
  OPTIONS (host 'dummy', port '0',
           dbname 'contrib_regression', multi_hosts 'localhost  localhost',
           multi_ports '5432  5555', num_segments '2', mpp_execute 'all segments');
CREATE USER MAPPING FOR CURRENT_USER SERVER pgserver;
-- ===================================================================
-- create objects used through FDW pgserver server
-- ===================================================================
-- remote postgres server 1 -- listening port 5432
\! env PGOPTIONS='' psql -p 5432 contrib_regression -f sql/postgres_sql/mpp_gp2pg_postgres_init_1.sql
SET
CREATE SCHEMA
CREATE TABLE
ALTER TABLE
INSERT 0 5
ANALYZE
-- remote postgres server 2 -- listening port 5555
\! env PGOPTIONS='' psql -p 5555 contrib_regression -f sql/postgres_sql/mpp_gp2pg_postgres_init_2.sql
SET
CREATE SCHEMA
CREATE TABLE
ALTER TABLE
INSERT 0 5
ANALYZE
-- ===================================================================
-- create foreign tables
-- ===================================================================
CREATE FOREIGN TABLE mpp_ft1 (
	c1 int,
	c2 int
) SERVER pgserver OPTIONS (schema_name 'MPP_S 1', table_name 'T 1');
-- ===================================================================
-- tests for validator
-- ===================================================================
-- Error when the length of option multi_hosts and multi_ports is NOT same.
CREATE SERVER testserver FOREIGN DATA WRAPPER postgres_fdw
  OPTIONS (dbname 'contrib_regression', multi_hosts 'localhost localhost',
           multi_ports '5432', num_segments '2', mpp_execute 'all segments');
ERROR:  The number of hosts and ports don't match in option 'multi_hosts' and 'multi_ports'.
-- Error when specifying option multi_hosts and multi_ports but option mpp_execute is NOT 'all segments'.
CREATE FOREIGN TABLE mpp_test (
	c1 int,
	c2 int
) SERVER pgserver OPTIONS (schema_name 'MPP_S 1', table_name 'T 1', mpp_execute 'coordinator');
SELECT * FROM mpp_test;
ERROR:  Only option mpp_execute is set to 'all segments', option multi_hosts and multi_ports is valid.
ALTER FOREIGN TABLE mpp_test OPTIONS (drop mpp_execute);
-- Error when the value of option num_segments is NOT same as the length of option multi_hosts and multi_ports.
ALTER SERVER pgserver OPTIONS (set num_segments '1');
SELECT * FROM mpp_test;
ERROR:  server option num_segments, multi_hosts and multi_ports don't match. (postgres_fdw.c:1498)  (seg0 slice1 127.0.0.1:7002 pid=24510)
ALTER SERVER pgserver OPTIONS (set num_segments '2');
-- ===================================================================
-- Simple queries
-- ===================================================================
EXPLAIN VERBOSE SELECT * FROM mpp_ft1 ORDER BY c1;
                                      QUERY PLAN                                      
--------------------------------------------------------------------------------------
 Gather Motion 2:1  (slice1; segments: 2)  (cost=100.00..5558.20 rows=172200 width=8)
   Output: c1, c2
   Merge Key: c1
   ->  Foreign Scan on public.mpp_ft1  (cost=100.00..2975.20 rows=86100 width=8)
         Output: c1, c2
         Remote SQL: SELECT c1, c2 FROM "MPP_S 1"."T 1" ORDER BY c1 ASC NULLS LAST
 Optimizer: Postgres query optimizer
 Settings: gp_enable_minmax_optimization = 'off', optimizer = 'off'
(8 rows)

SELECT * FROM mpp_ft1 ORDER BY c1;
 c1 | c2 
----+----
  1 |  1
  2 |  0
  3 |  1
  4 |  0
  5 |  1
  6 |  0
  7 |  1
  8 |  0
  9 |  1
 10 |  0
(10 rows)

ALTER FOREIGN TABLE mpp_ft1 OPTIONS (add use_remote_estimate 'true');
EXPLAIN VERBOSE SELECT * FROM mpp_ft1 ORDER BY c1;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Gather Motion 2:1  (slice1; segments: 2)  (cost=102.22..102.74 rows=20 width=8)
   Output: c1, c2
   Merge Key: c1
   ->  Foreign Scan on public.mpp_ft1  (cost=102.22..102.44 rows=10 width=8)
         Output: c1, c2
         Remote SQL: SELECT c1, c2 FROM "MPP_S 1"."T 1" ORDER BY c1 ASC NULLS LAST
 Optimizer: Postgres query optimizer
 Settings: gp_enable_minmax_optimization = 'off', optimizer = 'off'
(8 rows)

SELECT * FROM mpp_ft1 ORDER BY c1;
 c1 | c2 
----+----
  1 |  1
  2 |  0
  3 |  1
  4 |  0
  5 |  1
  6 |  0
  7 |  1
  8 |  0
  9 |  1
 10 |  0
(10 rows)

ALTER FOREIGN TABLE mpp_ft1 OPTIONS (drop use_remote_estimate);
-- ===================================================================
-- When there are multiple remote servers, we don't support IMPORT FOREIGN SCHEMA
-- ===================================================================
CREATE SCHEMA mpp_import_dest;
IMPORT FOREIGN SCHEMA import_source FROM SERVER pgserver INTO mpp_import_dest;
ERROR:  If there are multiple remote servers, gpdb doesn't support import foreign schema
-- ===================================================================
-- When there are multiple remote servers, we don't support INSERT/UPDATE/DELETE
-- ===================================================================
INSERT INTO mpp_ft1 VALUES (1, 1);
ERROR:  foreign table "mpp_ft1" does not allow inserts
UPDATE mpp_ft1 SET c1 = c1 + 1;
ERROR:  foreign table "mpp_ft1" does not allow updates
DELETE FROM mpp_ft1;
ERROR:  foreign table "mpp_ft1" does not allow deletes
