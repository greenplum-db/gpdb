-- ===================================================================
-- create FDW objects
-- ===================================================================
CREATE EXTENSION pxf_fdw;
DROP ROLE IF EXISTS pxf_fdw_user;
CREATE ROLE pxf_fdw_user;
NOTICE:  resource queue required -- using default resource queue "pg_default"
-- ===================================================================
-- Validation for WRAPPER options
-- ===================================================================
-- When 'protocol' option is not provided during WRAPPER creation, an error
-- should be given to the user and the WRAPPER creation should be aborted.
CREATE FOREIGN DATA WRAPPER dummy_pxf_fdw
    HANDLER pxf_fdw_handler
    VALIDATOR pxf_fdw_validator;
ERROR:  the protocol option is required for PXF foreign-data wrappers
-- When 'protocol' option is blank during WRAPPER creation, an error
-- should be given to the user and the WRAPPER creation should be aborted.
CREATE FOREIGN DATA WRAPPER dummy_pxf_fdw
    HANDLER pxf_fdw_handler
    VALIDATOR pxf_fdw_validator
    OPTIONS ( protocol '' );
ERROR:  the protocol option is required for PXF foreign-data wrappers
-- Foreign Data Wrapper Succeeds when protocol is provided
CREATE FOREIGN DATA WRAPPER dummy_pxf_fdw
    HANDLER pxf_fdw_handler
    VALIDATOR pxf_fdw_validator
    OPTIONS ( protocol 'dummy' );
-- When 'protocol' option is dropped, an error should be given to the user
-- and the WRAPPER alteration should be aborted.
ALTER FOREIGN DATA WRAPPER dummy_pxf_fdw
    OPTIONS ( DROP protocol );
ERROR:  the protocol option is required for PXF foreign-data wrappers
-- ===================================================================
-- Validation for SERVER options
-- ===================================================================
-- Server creation fails if protocol option is provided
CREATE SERVER dummy_server
    FOREIGN DATA WRAPPER dummy_pxf_fdw
    OPTIONS ( protocol 'dummy2' );
ERROR:  the protocol option cannot be defined at the server level
-- Server creation succeeds if protocol option is not provided
CREATE SERVER dummy_server
    FOREIGN DATA WRAPPER dummy_pxf_fdw;
-- Altering a server fails if protocol option is added
ALTER SERVER dummy_server
    OPTIONS ( ADD protocol 'dummy2' );
ERROR:  the protocol option cannot be defined at the server level
-- ===================================================================
-- Validation for USER MAPPING options
-- ===================================================================
-- User mapping creation fails if protocol option is provided
CREATE USER MAPPING FOR pxf_fdw_user
    SERVER dummy_server
    OPTIONS ( protocol 'usermappingprotocol' );
ERROR:  the protocol option cannot be defined at the user-mapping level
